const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./DLjhuocD.js","./CqkleIqs.js"])))=>i.map(i=>d[i]);
import{d as J,q as ce,i as G,l as de,a2 as pe,G as ve,o as r,c,F as me,h as o,e as i,u as s,B as T,w as m,j as B,b as A,f,a as fe,t as ge,Y as H,W as xe,D as ye,V as he,r as n,N as _,g as L,z as be}from"./BO0_OeXi.js";import{E as _e}from"./ChWJ63gv.js";import{L as W}from"./BWQX0J8z.js";import{M as we}from"./oEsFR4E0.js";import{c as ke}from"./ChLhOB94.js";const ze=ke("locate-fixed",[["line",{x1:"2",x2:"5",y1:"12",y2:"12",key:"bvdh0s"}],["line",{x1:"19",x2:"22",y1:"12",y2:"12",key:"1tbv5k"}],["line",{x1:"12",x2:"12",y1:"2",y2:"5",key:"11lu5j"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}],["circle",{cx:"12",cy:"12",r:"7",key:"fim9np"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]),Ce={class:"space-y-4"},Se={class:"space-y-2"},Te={class:"flex flex-wrap items-end justify-between gap-3"},Be={class:"relative -mx-4 -mt-2 overflow-hidden rounded-b-3xl border border-border bg-muted shadow-soft sm:rounded-3xl"},Le={key:0,class:"absolute left-1/2 top-4 z-20 -translate-x-1/2"},Me={class:"absolute right-4 top-4 z-20 flex flex-col gap-2"},Ee={key:1,class:"absolute left-4 top-4 z-20 flex items-center gap-2 rounded-full border border-border bg-card/90 px-3 py-2 text-xs text-muted-foreground shadow-soft"},Ne={key:2,class:"absolute bottom-4 right-4 z-20 max-w-[220px] rounded-2xl border border-destructive/30 bg-destructive/10 p-3 text-xs text-destructive shadow-soft"},Fe={class:"mx-auto w-full max-w-md rounded-3xl border border-border bg-white p-4 shadow-elevated dark:bg-neutral-900"},$e={class:"flex items-center justify-between"},Ae={key:0,class:"mt-2 text-xs text-muted-foreground"},De=800,Oe=12,Ve=J({__name:"MapMainBlock",setup(K){const D=ce(),w=n(null),u=_(null),k=_(null),O=_(null),M=_(null),E=_(null),N=n([]),g=n(null),d=n(!1),x=n(""),z=n(!1),p=n(""),V=n(""),C=n(!1),y=n(null),h=n(0),Y=n(0),F=n(!1),I={lat:55.751,lon:37.617},P=L(()=>{const t=g.value;return t?{id:t.id,uuid:t.uuid??`map-${t.id}`,title:t.title??"Событие на карте",description:t.description??"",slug:t.slug??`event-${t.id}`,main_image:t.main_image??null,venue_name:t.venue_name??null,city:t.city??"Город не указан",start_time:t.start_time??null,tags:t.tags??[],going_count:t.going_count??0,going_avatars:t.going_avatars??[]}:null}),R=L(()=>!!g.value?.slug),j=L(()=>!!g.value),$=()=>{g.value=null,h.value=0},Q=t=>{F.value=!0,Y.value=t.touches[0]?.clientY??0},X=t=>{if(!F.value)return;const e=t.touches[0]?.clientY??0;h.value=Math.max(0,e-Y.value)},ee=()=>{h.value>90?$():h.value=0,F.value=!1},te=L(()=>({transform:`translateY(${h.value}px)`})),U=t=>{const e=t.getBounds(),a=l=>l.toFixed(5);return`${a(e.getWest())},${a(e.getSouth())},${a(e.getEast())},${a(e.getNorth())}`},q=async t=>{if(t){d.value=!0,x.value="";try{const e=await D.apiFetch("/api/v1/discovery/map",{baseURL:be("/api/v1/discovery/map"),query:{bbox:t,zoom:u.value?.getZoom?.()}});N.value=e||[],V.value=t,z.value=!1}catch{x.value="Не удалось загрузить события на карте."}finally{d.value=!1}}},ae=()=>{u.value&&(p.value=U(u.value),z.value=p.value!==V.value)},se=()=>{!p.value||d.value||q(p.value)},oe=t=>{const e=Number(t.view_count??t.going_count??t.id%70)||1;return Math.max(1,e)},ne=t=>{const e=Date.now();if(t.is_live_active??t.is_live??!1)return"current";const l=String(t.status??t.category??"").toLowerCase();if(["live","current","now","today"].some(b=>l.includes(b)))return"current";const v=t.start_time,S=t.end_time;if(v){const b=new Date(v).getTime(),ue=S?new Date(S).getTime():b+14400*1e3;if(!Number.isNaN(b)&&e>=b&&e<=ue)return"current"}return"future"},le=t=>{const e=k.value;if(!e)return null;const a=oe(t),l=Math.round(18+Math.min(26,Math.sqrt(a)*3)),S=ne(t)==="current"?"map-pin--live":"map-pin--future";return e.divIcon({className:"map-pin-wrapper",html:`<div class="map-pin ${S}" style="--size:${l}px"><span class="map-pin__dot"></span></div>`,iconSize:[l,l],iconAnchor:[l/2,l]})},re=()=>{const t=k.value,e=O.value;!t||!e||(e.clearLayers(),N.value.forEach(a=>{if(typeof a.lat!="number"||typeof a.lon!="number")return;const l=le(a),v=t.marker([a.lat,a.lon],{icon:l??void 0,riseOnHover:!0});v.on("click",()=>{g.value=a}),v.addTo(e)}))},Z=()=>{const t=k.value,e=u.value;if(!t||!e||!y.value)return;const a=[y.value.lat,y.value.lon];M.value?M.value.setLatLng(a):M.value=t.circleMarker(a,{radius:6,weight:2,color:"#6D28D9",fillColor:"#8B5CF6",fillOpacity:.9}).addTo(e),E.value?E.value.setLatLng(a):E.value=t.circle(a,{radius:De,color:"#A78BFA",weight:1,fillColor:"#A78BFA",fillOpacity:.12}).addTo(e)},ie=()=>{navigator.geolocation&&(C.value=!0,navigator.geolocation.getCurrentPosition(t=>{const{latitude:e,longitude:a}=t.coords;y.value={lat:e,lon:a},Z(),u.value?.flyTo?.([e,a],14,{duration:.8}),C.value=!1},()=>{C.value=!1,x.value="Не удалось получить геолокацию."},{enableHighAccuracy:!0,timeout:8e3}))};return G(N,()=>re(),{deep:!0}),G(y,()=>Z()),de(async()=>{if(!w.value)return;const t=await pe(()=>import("./DLjhuocD.js").then(a=>a.l),__vite__mapDeps([0,1]),import.meta.url);k.value=t;const e=t.map(w.value,{zoomControl:!1,attributionControl:!1,preferCanvas:!0}).setView([I.lat,I.lon],Oe);u.value=e,t.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"Â© OpenStreetMap"}).addTo(e),t.control.zoom({position:"bottomright"}).addTo(e),O.value=t.layerGroup().addTo(e),e.on("moveend",ae),e.whenReady(()=>{p.value=U(e),q(p.value)}),setTimeout(()=>{e.invalidateSize()},200)}),ve(()=>{u.value&&(u.value.off(),u.value.remove())}),(t,e)=>(r(),c(me,null,[o("div",Ce,[o("header",Se,[e[2]||(e[2]=o("p",{class:"text-xs font-semibold uppercase tracking-[0.3em] text-muted-foreground"}," Карта города ",-1)),o("div",Te,[e[1]||(e[1]=o("div",null,[o("h1",{class:"text-2xl font-bold text-foreground"},"Карта событий"),o("p",{class:"text-sm text-muted-foreground"}," Двигай карту и выбирай, куда отправиться сегодня. ")],-1)),i(s(T),{variant:"secondary",size:"sm",class:"rounded-full"},{default:m(()=>[...e[0]||(e[0]=[B(" Фильтры ",-1)])]),_:1})])]),o("div",Be,[o("div",{ref_key:"mapEl",ref:w,class:"h-[calc(100svh-240px)] min-h-[440px] w-full"},null,512),s(z)?(r(),c("div",Le,[i(s(T),{size:"sm",class:"rounded-full px-4 shadow-glow gap-2",disabled:s(d),onClick:se},{default:m(()=>[s(d)?(r(),A(s(W),{key:0,class:"h-4 w-4 animate-spin"})):(r(),A(s(we),{key:1,class:"h-4 w-4"})),e[3]||(e[3]=B(" Искать в этой области ",-1))]),_:1},8,["disabled"])])):f("",!0),o("div",Me,[i(s(T),{variant:"secondary",size:"icon",class:"rounded-full shadow-soft",disabled:s(C),onClick:ie},{default:m(()=>[i(s(ze),{class:"h-4 w-4"})]),_:1},8,["disabled"])]),e[5]||(e[5]=fe('<div class="absolute bottom-4 left-4 z-20 flex items-center gap-2 rounded-full border border-border bg-card/90 px-3 py-2 text-[11px] text-muted-foreground shadow-soft"><span class="flex items-center gap-1"><span class="h-2.5 w-2.5 rounded-full bg-emerald-500"></span> Сейчас </span><span class="h-4 w-px bg-border"></span><span class="flex items-center gap-1"><span class="h-2.5 w-2.5 rounded-full bg-sky-500"></span> Скоро </span></div>',1)),s(d)&&!s(z)?(r(),c("div",Ee,[i(s(W),{class:"h-4 w-4 animate-spin"}),e[4]||(e[4]=B(" Загружаем события ",-1))])):f("",!0),s(x)?(r(),c("div",Ne,ge(s(x)),1)):f("",!0)]),e[6]||(e[6]=o("p",{class:"text-xs text-muted-foreground"}," Подвинь карту и нажми Â«Искать в этой областиÂ», чтобы обновить точки. ",-1))]),(r(),A(he,{to:"body"},[i(H,{"enter-active-class":"transition-opacity duration-200","enter-from-class":"opacity-0","enter-to-class":"opacity-100","leave-active-class":"transition-opacity duration-200","leave-from-class":"opacity-100","leave-to-class":"opacity-0"},{default:m(()=>[s(j)?(r(),c("div",{key:0,class:"fixed inset-0 z-[80] bg-black/40",onClick:$})):f("",!0)]),_:1}),i(H,{"enter-active-class":"transition-transform duration-200 ease-out","enter-from-class":"translate-y-8 opacity-0","enter-to-class":"translate-y-0 opacity-100","leave-active-class":"transition-transform duration-200 ease-in","leave-from-class":"translate-y-0 opacity-100","leave-to-class":"translate-y-8 opacity-0"},{default:m(()=>[s(j)&&s(P)?(r(),c("div",{key:0,class:"fixed inset-x-0 bottom-20 z-[90] px-4 sm:bottom-6",style:xe(s(te)),onTouchstart:Q,onTouchmove:X,onTouchend:ee},[o("div",Fe,[o("div",$e,[e[8]||(e[8]=o("p",{class:"text-xs font-semibold uppercase tracking-[0.3em] text-muted-foreground"}," Предпросмотр ",-1)),i(s(T),{variant:"ghost",size:"sm",class:"rounded-full",onClick:$},{default:m(()=>[...e[7]||(e[7]=[B(" Закрыть ",-1)])]),_:1})]),o("div",{class:ye(["mt-3",s(R)?"":"pointer-events-none opacity-80"])},[i(_e,{event:s(P),compact:!0},null,8,["event"])],2),s(R)?f("",!0):(r(),c("p",Ae," Полные данные скоро будут доступны. "))])],36)):f("",!0)]),_:1})]))],64))}}),Ye={class:"page-wrapper"},qe=J({__name:"index",setup(K){return(D,w)=>(r(),c("div",Ye,[i(Ve)]))}});export{qe as default};
