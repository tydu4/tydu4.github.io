import{d as X,c as l,a as s,F as U,p as I,b as h,_ as ue,w as C,m as f,f as M,o as c,q as ce,t as k,k as le,J as me,O as pe,j as E,z as J,g as fe,G as ge,r as p,K as m}from"./DIpL79ME.js";import{H as be,c as ve}from"./DS9zloey.js";import{F as he}from"./BmSfH-Ig.js";import{U as _e}from"./DSoaomjP.js";import{T as xe}from"./DaLxu3sz.js";import{F as we}from"./BGJOlVoo.js";import"./DlAUqK2U.js";import"./BTA2ybKl.js";import"./Ck3zTzEc.js";import"./BwSGWVKi.js";import"./CnmEv5PP.js";import"./Dh-MwfXC.js";import"./NaR5TDkT.js";import"./5jP3ovOk.js";import"./IcEvladL.js";import"./DTxndy0w.js";const ye={class:"pb-14"},ke={class:"grid gap-6 lg:grid-cols-[minmax(0,1fr)_18.5rem]"},Se={class:"min-w-0 space-y-6"},Fe={class:"sticky top-2 z-20 rounded-2xl border border-border bg-card/95 p-2 backdrop-blur-sm"},Le={class:"grid grid-cols-2 gap-1 rounded-xl bg-background p-1"},Me=["onClick"],Te={class:"block truncate"},Ue={key:0,class:"rounded-2xl border border-border bg-card p-4"},Ie={class:"rounded-xl border border-dashed border-border bg-background p-5 text-center"},Ne={key:1,class:"rounded-2xl border border-border bg-card p-6 text-center"},Re={key:2,class:"flex flex-col gap-6"},Ae={class:"hidden lg:flex lg:flex-col lg:gap-6"},Ce={class:"rounded-2xl border border-border bg-card p-4"},Ee={class:"flex items-center gap-2 text-sm font-semibold text-foreground"},Be={class:"mt-4 space-y-3"},De=["src","alt"],Pe={class:"min-w-0"},ze={class:"line-clamp-1 text-sm font-semibold text-foreground"},$e={class:"text-xs text-muted-foreground"},qe={class:"rounded-2xl border border-border bg-card p-4"},Ve={class:"flex items-center gap-2 text-sm font-semibold text-foreground"},Oe={class:"mt-4 space-y-3"},Ge={class:"mt-1 text-xs text-muted-foreground"},He={class:"mt-1 inline-flex items-center gap-1 text-xs font-semibold text-primary"},je=X({__name:"FeedMainBlock",props:{scope:{},activities:{},suggestions:{},trendingEvents:{},showBuddiesEmptyState:{type:Boolean}},emits:["update:scope"],setup(g,{emit:i}){const N=g,_=i,S=[{label:"Buddies",value:"buddies"},{label:"Global",value:"global"}],b=v=>{v!==N.scope&&_("update:scope",v)};return(v,r)=>{const x=ue;return c(),l("section",ye,[s("div",ke,[s("div",Se,[s("header",Fe,[r[0]||(r[0]=s("div",{class:"mb-2 px-2 pt-1"},[s("p",{class:"text-[11px] font-semibold uppercase tracking-[0.18em] text-muted-foreground"}," The Pulse ")],-1)),s("div",Le,[(c(),l(U,null,I(S,a=>s("button",{key:a.value,type:"button",class:ce(["min-w-0 rounded-lg px-2 py-2 text-sm font-semibold transition sm:px-3",a.value===g.scope?"bg-card text-foreground border border-border shadow-sm":"text-muted-foreground hover:text-foreground"]),onClick:T=>b(a.value)},[s("span",Te,k(a.label),1)],10,Me)),64))])]),g.showBuddiesEmptyState?(c(),l("section",Ue,[s("div",Ie,[r[2]||(r[2]=s("p",{class:"text-sm font-semibold text-foreground"}," Your buddies feed is quiet right now. ",-1)),r[3]||(r[3]=s("p",{class:"mt-1 text-sm text-muted-foreground"}," Add new people to unlock social momentum. ",-1)),h(x,{to:"/community/buddies",class:"mt-4 inline-flex rounded-full border border-border bg-card px-4 py-2 text-sm font-semibold text-foreground transition hover:bg-muted"},{default:C(()=>[...r[1]||(r[1]=[M(" Find Friends ",-1)])]),_:1})])])):g.activities.length?(c(),l("section",Re,[(c(!0),l(U,null,I(g.activities,a=>(c(),le(he,{key:a.id,activity:a},null,8,["activity"]))),128))])):(c(),l("section",Ne,[...r[4]||(r[4]=[s("p",{class:"text-sm text-muted-foreground"}," No activity yet. Check back in a moment. ",-1)])]))]),s("aside",Ae,[s("section",Ce,[s("header",Ee,[h(f(_e),{class:"h-4 w-4"}),r[5]||(r[5]=M(" Who to follow ",-1))]),s("div",Be,[(c(!0),l(U,null,I(g.suggestions,a=>(c(),l("article",{key:a.uuid,class:"flex items-center justify-between gap-2"},[h(x,{to:`/u/${a.uuid}`,class:"flex min-w-0 items-center gap-2.5"},{default:C(()=>[s("img",{src:a.avatar,alt:a.name,class:"h-9 w-9 rounded-full border border-border",loading:"lazy"},null,8,De),s("div",Pe,[s("p",ze,k(a.name),1),s("p",$e,k(a.mutualFriends)+" mutual buddies ",1)])]),_:2},1032,["to"]),r[6]||(r[6]=s("button",{type:"button",class:"shrink-0 rounded-full border border-border bg-background px-3 py-1 text-xs font-semibold text-foreground transition hover:bg-muted"}," Follow ",-1))]))),128))])]),s("section",qe,[s("header",Ve,[h(f(xe),{class:"h-4 w-4"}),r[7]||(r[7]=M(" Trending Events ",-1))]),s("div",Oe,[(c(!0),l(U,null,I(g.trendingEvents,a=>(c(),l("article",{key:a.slug,class:"rounded-xl border border-border bg-background p-3"},[h(x,{to:`/e/${a.slug}`,class:"line-clamp-2 text-sm font-semibold text-foreground transition hover:text-primary"},{default:C(()=>[M(k(a.title),1)]),_:2},1032,["to"]),s("p",Ge,k(a.dateLabel)+" - "+k(a.city),1),s("p",He,[h(f(we),{class:"h-3.5 w-3.5"}),M(" "+k(a.pulse)+" pulse ",1)])]))),128))])])])])])}}}),Ke={class:"page-wrapper"},We={class:"flex min-h-[calc(100dvh-9rem)] flex-col gap-4 lg:flex-row lg:items-start lg:gap-6"},Je={class:"min-w-0 flex-1"},Y=30,B=6,Q=6,mt=X({__name:"index",setup(g){const i=me(),N=pe(),_=p("buddies"),S=p([]),b=p([]),v=p([]),r=p(!1),x=p(new Set),a=p(new Set),T=p(new Set),R=p(new Set),F=t=>!t||typeof t!="object"?{}:t,d=(t,e="")=>typeof t!="string"?e:t.trim()||e,D=(t,e="")=>typeof t=="number"&&Number.isFinite(t)?String(Math.round(t)):d(t,e),w=(t,e=0)=>{const o=Number(t);return Number.isFinite(o)?o:e},Z=(t,e=!1)=>{if(typeof t=="boolean")return t;if(typeof t=="string"){const o=t.trim().toLowerCase();if(o==="true")return!0;if(o==="false")return!1}return e},ee=E(()=>N.path.replace(/\/+$/,"")==="/community/feed"),te=t=>{const e=d(t);if(!e)return"Date TBA";const o=new Date(e);return Number.isNaN(o.getTime())?"Date TBA":new Intl.DateTimeFormat("en-US",{weekday:"short",month:"short",day:"numeric"}).format(o)},A=(t,e)=>{if(Array.isArray(t))return t.map(n=>F(n));const o=F(t);for(const n of e){const u=o[n];if(Array.isArray(u))return u.map(y=>F(y))}return[]},oe=t=>{const e=F(t.actor);return{id:Math.max(0,Math.round(w(e.id??t.actor_id,0))),username:d(e.username??e.full_name??e.name??t.actor_username,"Community member"),avatar_url:d(e.avatar_url??e.avatar??t.actor_avatar_url)||null,level:Math.max(1,Math.round(w(e.level??t.actor_level,1)))}},se=(t,e)=>{const o=t.target_id,n=Number(o),u=Number.isFinite(n)?Math.round(n):null;return{id:Math.max(1,Math.round(w(t.id,e+1))),activity_type:d(t.activity_type??t.type,"unknown"),target_id:u,target_type:d(t.target_type)||null,metadata:F(t.metadata),created_at:d(t.created_at??t.timestamp,new Date().toISOString()),actor:oe(t),reactions_count:Math.max(0,Math.round(w(t.reactions_count??t.reaction_count??t.fire_count,0))),comments_count:Math.max(0,Math.round(w(t.comments_count??t.comment_count,0))),is_reacted:Z(t.is_reacted,!1)}},P=t=>A(t,["items","activities","results","feed"]).map((e,o)=>se(e,o)).sort((e,o)=>new Date(o.created_at).getTime()-new Date(e.created_at).getTime()),z=t=>A(t,["items","recommendations","users","results"]).slice(0,B).map((e,o)=>({uuid:D(e.uuid??e.user_uuid??e.id??e.username,`suggested-${o+1}`),name:d(e.username??e.full_name??e.name,"Community member"),avatar:d(e.avatar_url??e.avatar??e.image_url),mutualFriends:Math.max(0,Math.round(w(e.mutual_count??e.mutual_buddies??e.mutual_friends,0)))})).filter(e=>e.uuid&&!x.value.has(e.uuid)),$=t=>A(t,["items","events","results","trending"]).map((e,o)=>{const n=D(e.slug??e.event_slug??e.id,`event-${o+1}`),u=w(e.pulse_score??e.pulse??e.momentum??e.score??e.trending_score,0);return{slug:n,title:d(e.title??e.event_title,"Trending event"),city:d(e.city??e.venue_city??e.venue_name,"City TBA"),dateLabel:te(e.starts_at??e.start_time??e.created_at),pulse:Math.max(0,Math.round(u))}}).filter(e=>e.slug).sort((e,o)=>o.pulse-e.pulse).slice(0,Q),q=async()=>{r.value=!0;const t=_.value==="buddies"?"buddies":"global";try{try{const e=await i.apiFetch("/api/v1/social/pulse",{baseURL:m("/api/v1/social/pulse"),query:{tab:t,scope:t,limit:Y,offset:0}});S.value=P(e);return}catch{}try{const e=await i.apiFetch("/api/v1/community/feed",{baseURL:m("/api/v1/community/feed"),query:{tab:t,limit:Y,offset:0}});S.value=P(e)}catch{S.value=[]}}finally{r.value=!1}},ae=async()=>{try{const t=await i.apiFetch("/api/v1/buddies/recommendations",{baseURL:m("/api/v1/buddies/recommendations"),query:{limit:B}});b.value=z(t);return}catch{}try{const t=await i.apiFetch("/api/v1/community/suggestions",{baseURL:m("/api/v1/community/suggestions"),query:{limit:B,offset:0}});b.value=z(t)}catch{b.value=[]}},ne=async()=>{try{const t=await i.apiFetch("/api/v1/events/trending",{baseURL:m("/api/v1/events/trending"),query:{limit:Q}});v.value=$(t);return}catch{}try{const t=await i.apiFetch("/api/v1/community/trending",{baseURL:m("/api/v1/community/trending")});v.value=$(t)}catch{v.value=[]}},V=async()=>{await Promise.allSettled([q(),ae(),ne()])},O=(t,e)=>{if(!t)return"";let o=t;try{o=t.startsWith("http")?new URL(t).pathname:t}catch{o=t}const n=o.match(e==="/u/"?/\/u\/([^/?#]+)/:/\/venue\/([^/?#]+)/);return decodeURIComponent(n?.[1]??"").trim()},G=(t,e)=>{const o=new Set(t.value);o.delete(e),t.value=o},H=(t,e)=>{const o=new Set(t.value);o.add(e),t.value=o},j=(t,e)=>{const o=new Set(t.value);o.add(e),t.value=o},re=async t=>{const e=t.trim();if(!(!e||T.value.has(e)||x.value.has(e))){H(T,e);try{const o=Number(e),n=Number.isFinite(o);try{await i.apiFetch("/api/v1/social/follow",{method:"POST",baseURL:m("/api/v1/social/follow"),body:{target_type:"user",user_uuid:e,target_user_uuid:e,user_id:n?Math.round(o):void 0,target_user_id:n?Math.round(o):void 0}})}catch{const y=`/api/v1/me/follow/${encodeURIComponent(e)}`;await i.apiFetch(y,{method:"POST",baseURL:m(y)})}j(x,e),b.value=b.value.filter(u=>u.uuid!==e)}catch{}finally{G(T,e)}}},ie=async t=>{const e=t.trim();if(!(!e||R.value.has(e)||a.value.has(e))){H(R,e);try{try{await i.apiFetch("/api/v1/social/follow",{method:"POST",baseURL:m("/api/v1/social/follow"),body:{target_type:"venue",venue_slug:e,slug:e}})}catch{const n=`/api/v1/public/venues/${encodeURIComponent(e)}/follow`;await i.apiFetch(n,{method:"POST",baseURL:m(n)})}j(a,e)}catch{}finally{G(R,e)}}},K=t=>{if(!ee.value)return;const e=t.target;if(!(e instanceof Element))return;const o=e.closest("button");if(!(o instanceof HTMLButtonElement)||o.disabled||d(o.textContent).toLowerCase()!=="follow")return;const n=o.closest("article");if(!n)return;const u=n.querySelector('a[href*="/u/"]');if(u){const L=O(u.getAttribute("href")??"","/u/");if(!L)return;t.preventDefault(),t.stopPropagation(),re(L);return}const y=n.querySelector('a[href*="/venue/"]');if(y){const L=O(y.getAttribute("href")??"","/venue/");if(!L)return;t.preventDefault(),t.stopPropagation(),ie(L)}},W=E(()=>S.value),de=E(()=>_.value==="buddies"&&!r.value&&W.value.length===0);return J(_,()=>{q()}),J(()=>i.token,()=>{V()}),fe(()=>{V(),document.addEventListener("click",K,!0)}),ge(()=>{document.removeEventListener("click",K,!0)}),(t,e)=>(c(),l("div",Ke,[s("div",We,[h(be,{items:f(ve),class:"shrink-0"},null,8,["items"]),s("div",Je,[h(je,{scope:f(_),activities:f(W),suggestions:f(b),"trending-events":f(v),"show-buddies-empty-state":f(de),"onUpdate:scope":e[0]||(e[0]=o=>_.value=o)},null,8,["scope","activities","suggestions","trending-events","show-buddies-empty-state"])])])]))}});export{mt as default};
