import{d as O,o as r,c as u,h as o,u as s,g as k,e as c,F as $,A as I,t as N,D as ve,B as T,w as C,j as z,q as fe,v as pe,E as me,i as Z,l as ye,G as xe,f as L,b as ee,Y as te,V as be,r as g,z as A}from"./BO0_OeXi.js";import{E as he}from"./ChWJ63gv.js";import{S as ke}from"./BIVUFcDL.js";import{c as _e}from"./ChLhOB94.js";import{X as se}from"./kDTr-kfK.js";import{L as we}from"./BWQX0J8z.js";import"./DlAUqK2U.js";const Ce=_e("sliders-horizontal",[["path",{d:"M10 5H3",key:"1qgfaw"}],["path",{d:"M12 19H3",key:"yhmn1j"}],["path",{d:"M14 3v4",key:"1sua03"}],["path",{d:"M16 17v4",key:"1q0r14"}],["path",{d:"M21 12h-9",key:"1o4lsq"}],["path",{d:"M21 19h-5",key:"1rlt1p"}],["path",{d:"M21 5h-7",key:"1oszz2"}],["path",{d:"M8 10v4",key:"tgpxqk"}],["path",{d:"M8 12H3",key:"a7s4jb"}]]),Re={class:"grid grid-cols-1 gap-2 sm:grid-cols-2"},Le={class:"space-y-1"},$e=["value"],qe={class:"space-y-1"},Me=["value"],Ue=O({__name:"DateRangePicker",props:{modelValue:{default:()=>({from:"",to:""})}},emits:["update:modelValue"],setup(p,{emit:b}){const y=p,h=b,m=k(()=>y.modelValue?.from??""),v=k(()=>y.modelValue?.to??""),n=(d,l)=>{const i={from:m.value,to:v.value,[d]:l};i.from&&i.to&&i.from>i.to&&(d==="from"?i.to=l:i.from=l),h("update:modelValue",i)};return(d,l)=>(r(),u("div",Re,[o("label",Le,[l[2]||(l[2]=o("span",{class:"text-xs font-medium text-muted-foreground"},"С",-1)),o("input",{type:"date",value:s(m),class:"h-10 w-full rounded-md border border-input bg-background px-3 text-sm text-foreground ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",onInput:l[0]||(l[0]=i=>n("from",i.target.value))},null,40,$e)]),o("label",qe,[l[3]||(l[3]=o("span",{class:"text-xs font-medium text-muted-foreground"},"По",-1)),o("input",{type:"date",value:s(v),class:"h-10 w-full rounded-md border border-input bg-background px-3 text-sm text-foreground ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",onInput:l[1]||(l[1]=i=>n("to",i.target.value))},null,40,Me)])]))}}),Te=Object.assign(Ue,{__name:"SharedDateRangePicker"}),Ee={class:"space-y-5 rounded-2xl border border-border bg-card p-4 shadow-soft"},Ve={class:"space-y-2"},Fe={class:"space-y-2"},Be=["value"],Se=["value"],je={class:"space-y-2"},ze={key:0,class:"text-xs text-muted-foreground"},Ie={key:1,class:"flex flex-wrap gap-2"},Ne=["onClick"],Oe=O({__name:"CatalogFilters",props:{dateRange:{},city:{},cities:{},tags:{},selectedTags:{},loading:{type:Boolean,default:!1}},emits:["update:dateRange","update:city","toggle-tag","reset"],setup(p,{emit:b}){const y=p,h=b,m=v=>y.selectedTags.includes(v);return(v,n)=>(r(),u("div",Ee,[o("div",Ve,[n[3]||(n[3]=o("p",{class:"text-xs font-semibold uppercase tracking-[0.16em] text-muted-foreground"},"Дата",-1)),c(Te,{"model-value":p.dateRange,"onUpdate:modelValue":n[0]||(n[0]=d=>h("update:dateRange",d))},null,8,["model-value"])]),o("div",Fe,[n[5]||(n[5]=o("p",{class:"text-xs font-semibold uppercase tracking-[0.16em] text-muted-foreground"},"Город",-1)),o("select",{value:p.city,class:"h-10 w-full rounded-md border border-input bg-background px-3 text-sm text-foreground ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",onChange:n[1]||(n[1]=d=>h("update:city",d.target.value))},[n[4]||(n[4]=o("option",{value:""},"Все города",-1)),(r(!0),u($,null,I(p.cities,d=>(r(),u("option",{key:d,value:d},N(d),9,Se))),128))],40,Be)]),o("div",je,[n[6]||(n[6]=o("p",{class:"text-xs font-semibold uppercase tracking-[0.16em] text-muted-foreground"},"Теги",-1)),p.loading&&!p.tags.length?(r(),u("p",ze," Загружаем теги... ")):(r(),u("div",Ie,[(r(!0),u($,null,I(p.tags,d=>(r(),u("button",{key:d.slug,type:"button",class:ve(["rounded-full border px-3 py-1.5 text-xs font-medium transition-colors",m(d.slug)?"border-primary bg-primary/10 text-primary":"border-border bg-background text-muted-foreground hover:text-foreground"]),onClick:l=>h("toggle-tag",d.slug)},N(d.name),11,Ne))),128))]))]),c(s(T),{variant:"outline",class:"w-full",onClick:n[2]||(n[2]=d=>h("reset"))},{default:C(()=>[...n[7]||(n[7]=[z(" Сбросить фильтры ",-1)])]),_:1})]))}}),ae=Object.assign(Oe,{__name:"DiscoveryCatalogFilters"}),De={class:"-mx-4"},Pe={class:"mx-auto max-w-7xl space-y-5 px-4 pb-10 sm:px-6 lg:px-8"},Ae={class:"flex flex-wrap items-end justify-between gap-3"},He={key:0,class:"flex flex-wrap items-center gap-2 rounded-2xl border border-border bg-card px-4 py-3 text-sm text-foreground shadow-soft"},Qe={class:"font-medium"},Ge={class:"grid gap-6 lg:grid-cols-[18rem_minmax(0,1fr)]"},Ke={class:"hidden lg:block"},Xe={class:"space-y-4"},Ye={key:0,class:"rounded-2xl border border-destructive/30 bg-destructive/10 px-4 py-3 text-sm text-destructive"},Je={key:1,class:"grid gap-6 sm:grid-cols-2 xl:grid-cols-3"},We={class:"grid gap-6 sm:grid-cols-2 xl:grid-cols-3"},Ze={key:0,class:"rounded-2xl border border-border bg-card px-4 py-8 text-center text-sm text-muted-foreground shadow-soft"},et={key:3,class:"flex items-center justify-center gap-2 py-2 text-sm text-muted-foreground"},tt={key:4,class:"py-2 text-center text-xs uppercase tracking-[0.16em] text-muted-foreground"},st={key:0,class:"fixed inset-y-0 right-0 z-[95] w-full max-w-sm overflow-y-auto border-l border-border bg-card p-4 shadow-elevated lg:hidden"},at={class:"mb-4 flex items-center justify-between"},oe=18,ot=O({__name:"CatalogMainBlock",setup(p){const b=fe(),y=pe(),h=me(),m=g(!1),v=g([]),n=g([]),d=g([]),l=g({from:"",to:""}),i=g(""),f=g([]),q=g(!1),M=g(!1),E=g(!1),R=g(!0),V=g(""),D=g(0),_=g(0),F=g(null);let B=null;const w=k(()=>{const t=y.query.q;return typeof t=="string"?t.trim():""}),ne=k(()=>{const t=new Map;return n.value.forEach(e=>{t.set(e.slug,e.name.toLocaleLowerCase("ru-RU"))}),t}),H=k(()=>f.value.map(t=>ne.value.get(t)??t.toLocaleLowerCase("ru-RU"))),Q=k(()=>{const t=new Set;return d.value.forEach(e=>{const a=e.city?.trim();a&&t.add(a)}),v.value.forEach(e=>{const a=e.city?.trim();a&&a!=="Не указан"&&t.add(a)}),Array.from(t).sort((e,a)=>e.localeCompare(a,"ru-RU"))}),P=k(()=>{let t=v.value;if(w.value){const e=w.value.toLocaleLowerCase("ru-RU");t=t.filter(a=>[a.title,a.description??"",a.city,a.venue_name??"",...a.tags??[]].join(" ").toLocaleLowerCase("ru-RU").includes(e))}if(i.value){const e=i.value.toLocaleLowerCase("ru-RU");t=t.filter(a=>a.city.toLocaleLowerCase("ru-RU")===e)}return H.value.length&&(t=t.filter(e=>{const a=e.tags.map(x=>x.toLocaleLowerCase("ru-RU"));return H.value.every(x=>a.includes(x))})),t}),le=k(()=>[l.value.from,l.value.to,f.value[0]??"",i.value,w.value].join("|")),re=t=>{const e=t.occurrences?.[0],a=e?.venue??null,x=t.default_venue??a,U=t.images?.[0]?.url??null;return{id:t.id,uuid:t.uuid,title:t.title,description:t.description??"",slug:t.slug,main_image:U,venue_name:x?.name??e?.location_name??null,city:x?.city?.trim()||"Не указан",start_time:e?.start_time??null,tags:t.tags?.map(S=>S.name).filter(Boolean)??[],going_count:0,going_avatars:[]}},ie=t=>{const e={skip:t,limit:oe};return l.value.from&&(e.start_date=l.value.from),l.value.to&&(e.end_date=l.value.to),f.value[0]&&(e.tag_slug=f.value[0]),i.value&&(e.city=i.value),w.value&&(e.q=w.value),e},ue=async()=>{E.value=!0;try{const[t,e]=await Promise.all([b.apiFetch("/api/v1/events/tags",{baseURL:A("/api/v1/events/tags"),query:{limit:60}}),b.apiFetch("/api/v1/events/venues",{baseURL:A("/api/v1/events/venues"),query:{limit:200}})]);n.value=t??[],d.value=e??[]}catch{}finally{E.value=!1}},G=async({reset:t=!1,token:e=_.value}={})=>{if(M.value||!R.value&&!t)return;M.value=!0;const a=t?0:D.value;try{const x=await b.apiFetch("/api/v1/events/",{baseURL:A("/api/v1/events/"),query:ie(a)});if(e!==_.value)return;const U=x??[],S=U.map(re);if(t)v.value=S;else{const ge=new Set(v.value.map(j=>j.id));S.forEach(j=>{ge.has(j.id)||v.value.push(j)})}D.value=a+U.length,R.value=U.length===oe}catch{if(e!==_.value)return;V.value="Не удалось загрузить события. Попробуйте снова.",R.value=!1}finally{e===_.value&&(M.value=!1)}},de=async()=>{_.value+=1;const t=_.value;V.value="",v.value=[],R.value=!0,D.value=0,q.value=!0,await G({reset:!0,token:t}),t===_.value&&(q.value=!1)},K=t=>{l.value=t},X=t=>{i.value=t},Y=t=>{if(f.value.includes(t)){f.value=f.value.filter(e=>e!==t);return}f.value=[...f.value,t]},J=()=>{l.value={from:"",to:""},i.value="",f.value=[]},ce=async()=>{await h.replace({path:y.path,query:{...y.query,q:void 0}})},W=()=>{B?.disconnect(),B=new IntersectionObserver(t=>{t.some(a=>a.isIntersecting)&&(q.value||M.value||R.value&&G())},{rootMargin:"300px 0px 300px 0px"}),F.value&&B.observe(F.value)};return Z(le,()=>{de()},{immediate:!0}),Z(F,()=>{W()}),ye(()=>{ue(),W()}),xe(()=>{B?.disconnect()}),(t,e)=>(r(),u($,null,[o("div",De,[o("div",Pe,[o("header",Ae,[e[5]||(e[5]=o("div",{class:"space-y-1"},[o("h1",{class:"text-2xl font-bold text-foreground"},"Каталог событий"),o("p",{class:"text-sm text-muted-foreground"}," Подборка событий с фильтрами по датам, городу и тегам. ")],-1)),c(s(T),{variant:"outline",class:"gap-2 lg:hidden",onClick:e[0]||(e[0]=a=>m.value=!0)},{default:C(()=>[c(s(Ce),{class:"h-4 w-4"}),e[4]||(e[4]=z(" Фильтры ",-1))]),_:1})]),s(w)?(r(),u("div",He,[e[6]||(e[6]=o("span",{class:"text-muted-foreground"},"Поиск:",-1)),o("span",Qe,N(s(w)),1),c(s(T),{variant:"ghost",size:"icon",class:"ml-auto h-8 w-8 rounded-full",onClick:ce},{default:C(()=>[c(s(se),{class:"h-4 w-4"})]),_:1})])):L("",!0),o("div",Ge,[o("aside",Ke,[c(ae,{"date-range":s(l),city:s(i),cities:s(Q),tags:s(n),"selected-tags":s(f),loading:s(E),"onUpdate:dateRange":K,"onUpdate:city":X,onToggleTag:Y,onReset:J},null,8,["date-range","city","cities","tags","selected-tags","loading"])]),o("section",Xe,[s(V)?(r(),u("div",Ye,N(s(V)),1)):L("",!0),s(q)?(r(),u("div",Je,[(r(),u($,null,I(9,a=>c(ke,{key:`catalog-skeleton-${a}`})),64))])):(r(),u($,{key:2},[o("div",We,[(r(!0),u($,null,I(s(P),a=>(r(),ee(he,{key:a.id,event:a,"show-tags":!0,class:"h-full"},null,8,["event"]))),128))]),s(P).length?L("",!0):(r(),u("div",Ze," Событий по текущим фильтрам не найдено. "))],64)),o("div",{ref_key:"sentinelEl",ref:F,class:"h-1 w-full"},null,512),s(M)&&!s(q)?(r(),u("div",et,[c(s(we),{class:"h-4 w-4 animate-spin"}),e[7]||(e[7]=z(" Загружаем еще события... ",-1))])):!s(R)&&s(P).length?(r(),u("div",tt," Показаны все найденные события ")):L("",!0)])])])]),(r(),ee(be,{to:"body"},[c(te,{"enter-active-class":"transition-opacity duration-200","enter-from-class":"opacity-0","enter-to-class":"opacity-100","leave-active-class":"transition-opacity duration-200","leave-from-class":"opacity-100","leave-to-class":"opacity-0"},{default:C(()=>[s(m)?(r(),u("div",{key:0,class:"fixed inset-0 z-[90] bg-black/60 lg:hidden",onClick:e[1]||(e[1]=a=>m.value=!1)})):L("",!0)]),_:1}),c(te,{"enter-active-class":"transition-transform duration-200 ease-out","enter-from-class":"translate-x-full","enter-to-class":"translate-x-0","leave-active-class":"transition-transform duration-200 ease-in","leave-from-class":"translate-x-0","leave-to-class":"translate-x-full"},{default:C(()=>[s(m)?(r(),u("aside",st,[o("div",at,[e[8]||(e[8]=o("h2",{class:"text-lg font-semibold text-foreground"},"Фильтры",-1)),c(s(T),{variant:"ghost",size:"icon",class:"rounded-full",onClick:e[2]||(e[2]=a=>m.value=!1)},{default:C(()=>[c(s(se),{class:"h-4 w-4"})]),_:1})]),c(ae,{"date-range":s(l),city:s(i),cities:s(Q),tags:s(n),"selected-tags":s(f),loading:s(E),"onUpdate:dateRange":K,"onUpdate:city":X,onToggleTag:Y,onReset:J},null,8,["date-range","city","cities","tags","selected-tags","loading"]),c(s(T),{class:"mt-4 w-full",onClick:e[3]||(e[3]=a=>m.value=!1)},{default:C(()=>[...e[9]||(e[9]=[z(" Применить ",-1)])]),_:1})])):L("",!0)]),_:1})]))],64))}}),nt={class:"page-wrapper"},vt=O({__name:"index",setup(p){return(b,y)=>(r(),u("div",nt,[c(ot)]))}});export{vt as default};
