import{f as I,c as G,s as J,N as R,o as K,k as X,G as A,H as n,R as Z,O as o,J as w,K as S,L,S as q,v as i,y as f,F as $,M as T,X as z,Z as Q,$ as Y,a0 as ee}from"./DS7VCCSK.js";import U from"./Cjqy7nvW.js";import"./Deu-aWO1.js";import"./CdVBsagh.js";import"./BpcaaFkG.js";import"./DTeGA_vW.js";import"./D7xuzdeO.js";import"./BhfHb__k.js";import"./E0wZJRpp.js";import"./BxcSwu-R.js";import"./DU6-7vYD.js";import"./DmH-Mve6.js";import"./Bmm7Yk8C.js";import"./DF8zk2qc.js";import"./CeJFYvzK.js";import"./CfKVNkxc.js";import"./CFbK2b2T.js";import"./BBd-v6Ar.js";import"./DsmWHQFD.js";import"./CkYB-R1u.js";import"./c5FhCeC0.js";const te={class:"flex h-[calc(100vh-11rem)] min-h-[30rem] flex-col overflow-hidden rounded-2xl border border-slate-700 bg-slate-900 text-slate-100 shadow-inner"},oe={class:"flex flex-wrap items-center justify-between gap-4 border-b border-white/10 bg-slate-900/50 px-4 py-4 backdrop-blur-sm"},re={class:"flex items-center gap-4"},ae={class:"flex flex-wrap items-center gap-2"},se={class:"m-0 whitespace-pre-wrap font-mono text-emerald-300"},le={key:0,class:"border-t border-red-500/20 bg-red-500/10 px-4 py-2 text-xs text-red-200"},M=1e3,Ce=I({__name:"index",setup(ne){const h=G(),{token:d}=J(h),c=i([]),x=i(null),v=i(!0),m=i(!0),u=i(""),p=i(!1),r=i(null),l=i("idle");let a=null,b=0,g=!1;const N=f(()=>Y("/api/v1/admin/logs/download")),B=f(()=>{if(!d.value)return"";const e=ee("/api/v1/admin/logs/ws"),t="200";try{const s=new URL(e);return s.searchParams.has("lines")||s.searchParams.set("lines",t),s.toString()}catch{const s=window.location.protocol==="https:"?"wss:":"ws:",C=String(e).replace(/^(ws:|wss:)?\/\//,""),E=C.includes("?")?"&":"?";return`${s}//${C}${E}lines=${t}`}}),O=e=>{if(e)return["bearer",e]},y=e=>{const t=e.replace(/\r\n/g,`
`).split(`
`);t.length&&t[t.length-1]===""&&t.pop(),t.length&&(c.value.push(...t),c.value.length>M&&c.value.splice(0,c.value.length-M))},P=()=>{const e=x.value;if(!e)return;const t=24;v.value=e.scrollTop+e.clientHeight>=e.scrollHeight-t},k=async()=>{await Q();const e=x.value;e&&(e.scrollTop=e.scrollHeight)},_=()=>{if(!B.value)return;a&&(clearTimeout(a),a=null),g=!1,u.value="",l.value="connecting",r.value?.close();const e=new WebSocket(B.value,O(d.value));r.value=e,e.onopen=()=>{r.value===e&&(b=0,l.value="connected")},e.onerror=()=>{r.value===e&&(l.value="error")},e.onmessage=t=>{if(r.value===e){if(typeof t.data=="string"){y(t.data);return}if(t.data instanceof Blob){t.data.text().then(y).catch(()=>{});return}y(String(t.data))}},e.onclose=()=>{if(r.value!==e||(r.value=null,l.value!=="error"&&(l.value="idle"),g)||!d.value)return;b+=1;const t=Math.min(1e4,800*2**Math.min(5,b));a=setTimeout(_,t)}};R(d,()=>{if(!d.value){g=!0,a&&clearTimeout(a),a=null,r.value?.close(),r.value=null,l.value="idle";return}_()}),K(()=>{_()}),X(()=>{g=!0,a&&clearTimeout(a),r.value?.close()}),R(()=>c.value.length,()=>{m.value&&v.value&&k()});const j=f(()=>c.value.join(`
`)),H=async()=>{if(!p.value){u.value="",p.value=!0;try{await h.apiFetch("/api/v1/admin/logs/clear",{method:"POST",baseURL:z("/api/v1/admin/logs/clear")}),c.value=[],v.value=!0,await k()}catch{u.value="Не удалось очистить логи."}finally{p.value=!1}}},V=async()=>{u.value="";try{const e=await h.apiFetch("/api/v1/admin/logs/download",{baseURL:z("/api/v1/admin/logs/download"),responseType:"blob"}),t=URL.createObjectURL(e),s=document.createElement("a");s.href=t,s.download=`logs-${new Date().toISOString().slice(0,19).replace(/[:T]/g,"-")}.txt`,s.click(),URL.revokeObjectURL(t)}catch{{window.open(N.value,"_blank","noopener");return}}},W=()=>{m.value=!m.value,m.value&&(v.value=!0,k())},F=f(()=>{switch(l.value){case"connected":return"ОНЛАЙН";case"connecting":return"ПОДКЛЮЧЕНИЕ";case"error":return"ОШИБКА";default:return"ОФФЛАЙН"}}),D=f(()=>{switch(l.value){case"connected":return"text-green-400";case"connecting":return"text-amber-400";case"error":return"text-red-400";default:return"text-slate-500"}});return(e,t)=>($(),A("section",te,[n("header",oe,[n("div",re,[n("div",null,[t[0]||(t[0]=n("p",{class:"text-[10px] font-bold uppercase tracking-[0.2em] text-slate-500"},"System Logs",-1)),n("p",{class:Z(["mt-0.5 text-xs font-mono",o(D)])}," ● "+w(o(F)),3)])]),n("div",ae,[S(o(U),{variant:"secondary",size:"sm",class:"min-w-[7rem] bg-emerald-600 text-white hover:bg-emerald-700",onClick:V},{default:L(()=>[...t[1]||(t[1]=[T(" Скачать ",-1)])]),_:1}),S(o(U),{variant:"destructive",size:"sm",class:"min-w-[7rem] text-white",loading:o(p),disabled:o(p),onClick:H},{default:L(()=>[...t[2]||(t[2]=[T(" Очистить ",-1)])]),_:1},8,["loading","disabled"]),S(o(U),{variant:"outline",size:"sm",class:"min-w-[7rem] border-white/10 bg-slate-800 text-white hover:bg-slate-700",onClick:W},{default:L(()=>[T(w(o(m)?"Пауза":"Старт"),1)]),_:1})])]),n("div",{ref_key:"viewport",ref:x,class:"min-h-0 flex-1 overflow-x-auto overflow-y-auto bg-slate-950 p-5 font-mono text-[11px] leading-relaxed text-emerald-300 selection:bg-emerald-400/30",onScroll:P},[n("pre",se,""+w(o(j)||"> Ожидаем поток событий...")+`
      `,1)],544),o(u)?($(),A("footer",le,w(o(u)),1)):q("",!0)]))}});export{Ce as default};
