import N from"./Bc1u1-yo.js";import{u as be,G as ce,a2 as q,h as de,l as T,t as S,b as W,W as Q,O as u,R as t,B as C,D as o,P as v,M as x,N as l,Q as I,C as B,U as me,V as fe,X as pe,o as xe,S as ee,F as ye,n as Z}from"./Ca6rub8f.js";import{u as he}from"./B-wzc82F.js";import _e from"./CLa6BjNG.js";import ke from"./C79_LyIJ.js";import Ce from"./C3H3F2YC.js";import{S as Te}from"./CpSN0xDf.js";import $e from"./CMZtORL8.js";import De from"./OaEq_N85.js";import we from"./UmBt094f.js";import Ee from"./CIIq8pwL.js";import H from"./C1DnOOhT.js";import M from"./CqcWBI6N.js";import E from"./BmWhZwNF.js";import Se from"./BHL-Vmv6.js";import Le from"./DJ48-YcT.js";import Ue from"./CTg6Jk1j.js";import{C as Re,P as Be}from"./DAOe6maV.js";import{c as Fe}from"./Cibw3ATY.js";import"./CkYB-R1u.js";import"./c5FhCeC0.js";const Me=Fe("ellipsis",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]]),ge=new Intl.NumberFormat("ru-RU"),ve=new Intl.NumberFormat("ru-RU",{style:"currency",currency:"RUB",maximumFractionDigits:0}),Ve=new Intl.DateTimeFormat("ru-RU",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}),Pe=new Intl.DateTimeFormat("ru-RU",{day:"2-digit",month:"short",year:"numeric"}),te=e=>{if(!e)return 0;const a=Date.parse(e);return Number.isNaN(a)?0:a},ne=e=>e?Ve.format(new Date(e)):"Дата не указана",se=e=>e?Pe.format(new Date(e)):"Дата не указана",ae=e=>ve.format(Math.round(e)),le=e=>ge.format(Math.round(e)),Ae=e=>e.trim()?e.trim().split(" ").map(a=>a.charAt(0)).filter(Boolean).slice(0,2).join("").toUpperCase():"SE",oe=e=>e==="draft"?"Черновик":e==="scheduled"?"Запланировано":e==="cancelled"?"Отменено":e==="postponed"?"Перенесено":e==="done"?"Завершено":e,re=e=>e==="draft"?"warning":e==="scheduled"?"success":e==="postponed"?"warning":e==="cancelled"?"secondary":"outline",Oe=e=>{const a=e.default_venue;if(a?.name)return a.city?`${a.name}, ${a.city}`:a.name;const s=e.occurrences.find(f=>f.venue?.name)?.venue;return s?.name?s.city?`${s.name}, ${s.city}`:s.name:"Площадка не указана"},ze=e=>[...e.images??[]].sort((a,s)=>(a.sort_order??0)-(s.sort_order??0))[0]?.url||"",Ie=(e,a)=>e.status==="draft"||e.status==="cancelled"||e.status==="done"?!1:e.lastStartAtTs>=a,Ne=(e,a)=>e.status==="draft"?!1:e.status==="cancelled"||e.status==="done"?!0:e.lastStartAtTs>0&&e.lastStartAtTs<a,G=(e,a,s)=>a==="draft"?e.status==="draft":a==="upcoming"?Ie(e,s):a==="past"?Ne(e,s):!0,ie=e=>e?.name?{name:e.name,address:e.address??"",city:e.city??"",lat:e.lat??null,lon:e.lon??null}:null,ue=(e,a={})=>({title:a.title??e.title,slug:a.slug??e.slug,description:e.description??null,full_text:e.full_text??null,language:e.language??"ru",age_restriction:e.age_restriction??0,status:a.status??e.status,quality_score:e.quality_score??0,organizer:e.organizer??null,default_venue:ie(e.default_venue),tags:e.tags??[],occurrences:(e.occurrences??[]).map(s=>({start_time:s.start_time,end_time:s.end_time??null,tz:s.tz,status:s.status,location_name:s.location_name??null,venue:ie(s.venue)})),tickets:e.tickets??[],images:e.images??[],sources:[]}),je=e=>{const a=e.toLowerCase().replace(/[^a-z0-9-]+/g,"-").replace(/-+/g,"-").replace(/^-+|-+$/g,""),s=Date.now().toString(36);return`${a||"event"}-copy-${s}`.slice(0,96)},qe=()=>{const e=be(),a=T(""),s=T(""),f=T("all"),d=T("desc"),b=T(null),h=T(!1),_=T("");let m=null,k=null;ce(a,n=>{m&&clearTimeout(m),m=setTimeout(()=>{s.value=n.trim().toLowerCase()},250)});const{data:g,pending:L,refresh:y}=he("organizer-events-table",()=>e.apiFetch("/api/v1/events/",{baseURL:q("/api/v1/events/"),query:{limit:200}}),{default:()=>[]}),c=S(()=>g.value??[]),i=S(()=>c.value.map(n=>{const r=(n.occurrences??[]).map(w=>te(w.start_time)).filter(w=>w>0).sort((w,A)=>w-A),p=r[0]??0,$=r[r.length-1]??p,D=te(n.created_at),R=(n.tickets??[]).reduce((w,A)=>w+(A.sold??0),0),j=(n.tickets??[]).reduce((w,A)=>w+(A.price??0)*(A.sold??0),0);return{id:n.id,uuid:n.uuid,title:n.title,slug:n.slug,status:n.status,statusLabel:oe(n.status),statusVariant:re(n.status),coverUrl:ze(n),venueLabel:Oe(n),ticketsSold:R,ticketsSoldLabel:le(R),revenue:j,revenueLabel:ae(j),firstStartAtTs:p,lastStartAtTs:$,eventDateLabel:ne(p),createdAtTs:D,createdDateLabel:se(D),titleInitials:Ae(n.title)}})),U=S(()=>{const n=Date.now();return[{key:"all",label:"Все",count:i.value.length},{key:"upcoming",label:"Предстоящие",count:i.value.filter(r=>G(r,"upcoming",n)).length},{key:"past",label:"Прошедшие",count:i.value.filter(r=>G(r,"past",n)).length},{key:"draft",label:"Черновики",count:i.value.filter(r=>G(r,"draft",n)).length}]}),F=S(()=>{const n=Date.now(),r=s.value;let p=i.value.filter($=>G($,f.value,n));return r&&(p=p.filter($=>$.title.toLowerCase().includes(r))),p.sort(($,D)=>{const R=$.createdAtTs-D.createdAtTs;return R!==0?d.value==="asc"?R:-R:$.id-D.id}),p}),V=S(()=>i.value.reduce((n,r)=>({totalEvents:n.totalEvents+1,totalTicketsSold:n.totalTicketsSold+r.ticketsSold,totalRevenue:n.totalRevenue+r.revenue}),{totalEvents:0,totalTicketsSold:0,totalRevenue:0})),X=S(()=>d.value==="desc"?"новые сверху":"старые сверху"),P=n=>{_.value=n,k&&clearTimeout(k),k=setTimeout(()=>{_.value=""},3500)},O=async()=>{await y()},J=()=>{d.value=d.value==="desc"?"asc":"desc"},z=async n=>e.apiFetch(`/api/v1/events/${n}`,{baseURL:q("/api/v1/events")}),K=async n=>{b.value=n.id;try{const r=await z(n.uuid),p=ue(r,{title:`${r.title} (копия)`,slug:je(r.slug),status:"draft"});return await e.apiFetch("/api/v1/events/",{method:"POST",baseURL:q("/api/v1/events/"),body:p}),P(`Копия события "${n.title}" создана`),await O(),!0}catch{return P("Не удалось создать копию события"),!1}finally{b.value=null}},Y=async(n,r)=>{const p=r.trim();if(p.length<4)return!1;const $=i.value.find(D=>D.uuid===n)??null;h.value=!0;try{const D=await z(n),R=ue(D,{status:"cancelled"});await e.apiFetch(`/api/v1/events/${n}`,{method:"PUT",baseURL:q("/api/v1/events"),body:R});const j=$?.title??D.title;return P(`Событие "${j}" отменено. Причина: ${p}`),await O(),!0}catch{return P("Не удалось отменить событие"),!1}finally{h.value=!1}};return de(()=>{m&&clearTimeout(m),k&&clearTimeout(k)}),{search:a,activeTab:f,sortDirection:d,eventsData:g,pending:L,tabs:U,filteredRows:F,stats:V,sortDirectionLabel:X,actionMessage:_,clonePendingId:b,cancelPending:h,numberFormatter:ge,currencyFormatter:ve,formatDateTime:ne,formatShortDate:se,formatRevenue:ae,formatNumber:le,eventStatusLabel:oe,eventStatusVariant:re,refresh:O,toggleSortDirection:J,cloneEvent:K,cancelEvent:Y}},He={class:"space-y-4"},Ge={class:"space-y-1"},Qe={class:"text-sm text-muted-foreground"},We={class:"font-semibold text-foreground"},Xe={class:"space-y-2"},Je={class:"flex flex-wrap justify-end gap-2"},Ke=W({__name:"EventsCancelDialog",props:{isOpen:{type:Boolean},eventTitle:{default:""},loading:{type:Boolean,default:!1}},emits:["update:isOpen","confirm","close"],setup(e,{emit:a}){const s=e,f=a,d=T(""),b=S(()=>d.value.trim().length>=4&&!s.loading);ce(()=>s.isOpen,k=>{if(k){d.value="";return}s.loading||(d.value="")});const h=()=>{s.loading||(f("update:isOpen",!1),f("close"))},_=()=>{b.value&&f("confirm",d.value.trim())},m=k=>{f("update:isOpen",k),!k&&!s.loading&&f("close")};return(k,g)=>(C(),Q(t(ke),{"model-value":e.isOpen,"onUpdate:modelValue":m},{default:u(()=>[o("div",He,[o("div",Ge,[g[2]||(g[2]=o("h3",{class:"text-lg font-semibold text-foreground"},"Подтвердите отмену события",-1)),o("p",Qe,[g[1]||(g[1]=v(" Событие: ",-1)),o("span",We,x(e.eventTitle||"—"),1)])]),o("div",Xe,[g[3]||(g[3]=o("label",{class:"text-xs font-semibold uppercase tracking-[0.2em] text-muted-foreground"}," Причина отмены ",-1)),l(t(_e),{modelValue:t(d),"onUpdate:modelValue":g[0]||(g[0]=L=>I(d)?d.value=L:null),disabled:e.loading,placeholder:"Например: перенос площадки, отмена выступления хедлайнера"},null,8,["modelValue","disabled"])]),o("div",Je,[l(t(N),{variant:"outline",disabled:e.loading,onClick:h},{default:u(()=>[...g[4]||(g[4]=[v(" Назад ",-1)])]),_:1},8,["disabled"]),l(t(N),{variant:"destructive",disabled:!t(b),onClick:_},{default:u(()=>[v(x(e.loading?"Отменяем...":"Подтвердить отмену"),1)]),_:1},8,["disabled"])])])]),_:1},8,["model-value"]))}}),Ye=Object.assign(Ke,{__name:"EventsManagerEventsCancelDialog"}),Ze={class:"flex flex-wrap items-center justify-between gap-4"},et={class:"flex flex-1 flex-wrap items-center gap-3"},tt={class:"relative w-full max-w-md"},nt={class:"flex flex-wrap items-center gap-2"},st=["onClick"],at={class:"ml-2 rounded-full bg-background px-2 py-0.5 text-[11px] text-muted-foreground"},lt=W({__name:"EventsFilterBar",props:{tabs:{},activeTab:{},search:{},pending:{type:Boolean,default:!1}},emits:["update:activeTab","update:search","refresh"],setup(e,{emit:a}){const s=e,f=a,d=S({get:()=>s.activeTab,set:h=>{f("update:activeTab",h)}}),b=S({get:()=>s.search,set:h=>{f("update:search",h)}});return(h,_)=>(C(),B("div",Ze,[o("div",et,[o("div",tt,[l(t(Te),{class:"pointer-events-none absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),l(t(Ce),{modelValue:t(b),"onUpdate:modelValue":_[0]||(_[0]=m=>I(b)?b.value=m:null),class:"h-11 pl-10",placeholder:"Поиск по названию события"},null,8,["modelValue"])]),o("div",nt,[(C(!0),B(me,null,fe(e.tabs,m=>(C(),B("button",{key:m.key,type:"button",class:pe(["inline-flex items-center rounded-full px-4 py-2 text-xs font-semibold transition",t(d)===m.key?"bg-primary/10 text-primary":"text-muted-foreground hover:text-foreground"]),onClick:k=>d.value=m.key},[v(x(m.label)+" ",1),o("span",at,x(m.count),1)],10,st))),128))])]),l(t(N),{variant:"outline",size:"sm",disabled:e.pending,onClick:_[1]||(_[1]=m=>h.$emit("refresh"))},{default:u(()=>[..._[2]||(_[2]=[v(" Обновить ",-1)])]),_:1},8,["disabled"])]))}}),ot=Object.assign(lt,{__name:"EventsManagerEventsFilterBar"}),rt={class:"rounded-2xl border border-border bg-background"},it={class:"flex items-center gap-3"},ut={class:"space-y-0.5"},ct={class:"text-sm font-semibold text-foreground"},dt={class:"text-xs text-muted-foreground"},mt={class:"text-sm font-medium text-foreground"},ft={class:"text-xs text-muted-foreground"},pt={class:"truncate text-sm text-foreground"},gt={class:"relative inline-flex","data-row-menu-root":""},vt={key:0,class:"absolute right-0 z-30 mt-2 w-52 rounded-xl border border-border bg-background p-2 shadow-xl"},bt=["onClick"],xt=["onClick"],yt=["disabled","onClick"],ht=["disabled","onClick"],_t=W({__name:"EventsTable",props:{rows:{},pending:{type:Boolean},sortDirection:{default:"desc"},clonePendingId:{default:null},cancelPending:{type:Boolean,default:!1}},emits:["edit","dashboard","clone","cancel","sort-change"],setup(e,{emit:a}){const s=a,f=T(null),d=y=>{f.value=f.value===y?null:y},b=()=>{f.value=null},h=y=>{b(),s("edit",y)},_=y=>{b(),s("dashboard",y)},m=y=>{b(),s("clone",y)},k=y=>{b(),s("cancel",y)},g=()=>{s("sort-change")},L=y=>{y.target?.closest("[data-row-menu-root]")||b()};return xe(()=>{window.addEventListener("click",L)}),de(()=>{window.removeEventListener("click",L)}),(y,c)=>(C(),B("div",rt,[l(t(De),null,{default:u(()=>[l(t(we),null,{default:u(()=>[l(t(H),null,{default:u(()=>[l(t(M),null,{default:u(()=>[...c[0]||(c[0]=[v("Название",-1)])]),_:1}),l(t(M),null,{default:u(()=>[o("button",{type:"button",class:"inline-flex items-center gap-1 font-semibold text-muted-foreground transition hover:text-foreground",onClick:g},[c[1]||(c[1]=v(" Дата ",-1)),l(t(Re),{class:pe(["h-3.5 w-3.5",e.sortDirection==="asc"?"opacity-60":""])},null,8,["class"])])]),_:1}),l(t(M),null,{default:u(()=>[...c[2]||(c[2]=[v("Площадка",-1)])]),_:1}),l(t(M),null,{default:u(()=>[...c[3]||(c[3]=[v("Статус",-1)])]),_:1}),l(t(M),null,{default:u(()=>[...c[4]||(c[4]=[v("Билетов продано",-1)])]),_:1}),l(t(M),null,{default:u(()=>[...c[5]||(c[5]=[v("Выручка",-1)])]),_:1}),l(t(M),{class:"text-right"},{default:u(()=>[...c[6]||(c[6]=[v("Действия",-1)])]),_:1})]),_:1})]),_:1}),l(t(Ee),null,{default:u(()=>[e.pending?(C(),Q(t(H),{key:0},{default:u(()=>[l(t(E),{colspan:"7",class:"py-12 text-center text-sm text-muted-foreground"},{default:u(()=>[...c[7]||(c[7]=[v(" Загружаем события... ",-1)])]),_:1})]),_:1})):e.rows.length===0?(C(),Q(t(H),{key:1},{default:u(()=>[l(t(E),{colspan:"7",class:"py-12 text-center text-sm text-muted-foreground"},{default:u(()=>[...c[8]||(c[8]=[v(" События не найдены ",-1)])]),_:1})]),_:1})):ee("",!0),(C(!0),B(me,null,fe(e.rows,i=>(C(),Q(t(H),{key:i.id},{default:u(()=>[l(t(E),null,{default:u(()=>[o("div",it,[l(t(Se),{class:"h-10 w-10"},{default:u(()=>[l(t(Le),{src:i.coverUrl},null,8,["src"]),l(t(Ue),{class:"bg-primary/10 font-semibold text-primary"},{default:u(()=>[v(x(i.titleInitials),1)]),_:2},1024)]),_:2},1024),o("div",ut,[o("p",ct,x(i.title),1),o("p",dt,"slug: "+x(i.slug),1)])])]),_:2},1024),l(t(E),null,{default:u(()=>[o("p",mt,x(i.eventDateLabel),1),o("p",ft,"Создано: "+x(i.createdDateLabel),1)]),_:2},1024),l(t(E),{class:"max-w-[220px]"},{default:u(()=>[o("p",pt,x(i.venueLabel),1)]),_:2},1024),l(t(E),null,{default:u(()=>[l(t($e),{variant:i.statusVariant},{default:u(()=>[v(x(i.statusLabel),1)]),_:2},1032,["variant"])]),_:2},1024),l(t(E),{class:"font-semibold text-foreground"},{default:u(()=>[v(x(i.ticketsSoldLabel),1)]),_:2},1024),l(t(E),{class:"font-semibold text-foreground"},{default:u(()=>[v(x(i.revenueLabel),1)]),_:2},1024),l(t(E),{class:"text-right"},{default:u(()=>[o("div",gt,[l(t(N),{variant:"ghost",size:"icon",onClick:ye(U=>d(i.id),["stop"])},{default:u(()=>[l(t(Me),{class:"h-4 w-4"})]),_:1},8,["onClick"]),t(f)===i.id?(C(),B("div",vt,[o("button",{type:"button",class:"flex w-full items-center rounded-lg px-3 py-2 text-left text-sm hover:bg-muted",onClick:U=>h(i)}," Редактировать ",8,bt),o("button",{type:"button",class:"flex w-full items-center rounded-lg px-3 py-2 text-left text-sm hover:bg-muted",onClick:U=>_(i)}," Пульт управления ",8,xt),o("button",{type:"button",class:"flex w-full items-center rounded-lg px-3 py-2 text-left text-sm hover:bg-muted disabled:opacity-60",disabled:e.clonePendingId===i.id||e.cancelPending,onClick:U=>m(i)},x(e.clonePendingId===i.id?"Клонируем...":"Клонировать"),9,yt),o("button",{type:"button",class:"flex w-full items-center rounded-lg px-3 py-2 text-left text-sm text-destructive hover:bg-muted disabled:opacity-60",disabled:i.status==="cancelled"||e.cancelPending,onClick:U=>k(i)},x(i.status==="cancelled"?"Уже отменено":"Отменить"),9,ht)])):ee("",!0)])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]))}}),kt=Object.assign(_t,{__name:"EventsManagerEventsTable"}),Ct={class:"space-y-6"},Tt={class:"rounded-2xl border border-border bg-card p-6 shadow-sm"},$t={class:"flex flex-wrap items-center justify-between gap-4"},Dt={class:"rounded-2xl border border-border bg-card p-6 shadow-sm"},wt={class:"mt-3 flex flex-wrap items-center justify-between gap-2 text-xs text-muted-foreground"},Et={key:0,class:"mt-3 text-sm text-emerald-600"},St={class:"mt-5"},Kt=W({__name:"index",setup(e){const{search:a,activeTab:s,sortDirection:f,pending:d,tabs:b,filteredRows:h,sortDirectionLabel:_,actionMessage:m,clonePendingId:k,cancelPending:g,numberFormatter:L,refresh:y,toggleSortDirection:c,cloneEvent:i,cancelEvent:U}=qe(),F=T(!1),V=T(null),X=()=>{Z("/events/create")},P=n=>{Z(`/events/${n.id}/edit`)},O=n=>{Z(`/events/${n.id}/live`)},J=n=>{V.value=n,F.value=!0},z=()=>{g.value||(F.value=!1,V.value=null)},K=async n=>{const r=V.value;if(!r)return;await U(r.uuid,n)&&z()},Y=()=>{c()};return(n,r)=>(C(),B("div",Ct,[o("section",Tt,[o("div",$t,[r[4]||(r[4]=o("div",{class:"space-y-1"},[o("p",{class:"text-xs font-semibold uppercase tracking-[0.3em] text-muted-foreground"},"Event Manager"),o("h1",{class:"text-2xl font-bold text-foreground"},"Управление событиями"),o("p",{class:"text-sm text-muted-foreground"}," Управляй всеми ивентами в одном месте: статус, продажи, выручка и быстрые действия. ")],-1)),l(t(N),{class:"gap-2",onClick:X},{default:u(()=>[l(t(Be),{class:"h-4 w-4"}),r[3]||(r[3]=v(" Создать событие ",-1))]),_:1})])]),o("section",Dt,[l(ot,{search:t(a),"onUpdate:search":r[0]||(r[0]=p=>I(a)?a.value=p:null),"active-tab":t(s),"onUpdate:activeTab":r[1]||(r[1]=p=>I(s)?s.value=p:null),tabs:t(b),pending:t(d),onRefresh:t(y)},null,8,["search","active-tab","tabs","pending","onRefresh"]),o("div",wt,[o("span",null,"Показано: "+x(t(L).format(t(h).length)),1),o("span",null,"Сортировка: дата создания, "+x(t(_)),1)]),t(m)?(C(),B("p",Et,x(t(m)),1)):ee("",!0),o("div",St,[l(kt,{rows:t(h),pending:t(d),"sort-direction":t(f),"clone-pending-id":t(k),"cancel-pending":t(g),onEdit:P,onDashboard:O,onClone:t(i),onCancel:J,onSortChange:Y},null,8,["rows","pending","sort-direction","clone-pending-id","cancel-pending","onClone"])])]),l(Ye,{"is-open":t(F),"onUpdate:isOpen":r[2]||(r[2]=p=>I(F)?F.value=p:null),"event-title":t(V)?.title||"",loading:t(g),onConfirm:K,onClose:z},null,8,["is-open","event-title","loading"])]))}});export{Kt as default};
