import{b as Se,u as ze,a1 as Le,G as ee,h as Ae,C as S,D as s,M as i,R as t,N as o,O as n,Q as D,X as F,P as r,W as z,S as k,l as f,a2 as Ne,t as d,B as p,U as Re,V as Be}from"./Ca6rub8f.js";import c from"./Bc1u1-yo.js";import re from"./C3H3F2YC.js";import ie from"./CLa6BjNG.js";import ue from"./CMZtORL8.js";import je from"./OaEq_N85.js";import Ie from"./UmBt094f.js";import Ue from"./CIIq8pwL.js";import $ from"./C1DnOOhT.js";import C from"./CqcWBI6N.js";import g from"./BmWhZwNF.js";import De from"./BHL-Vmv6.js";import Fe from"./DJ48-YcT.js";import $e from"./CTg6Jk1j.js";import{u as Ge}from"./B-wzc82F.js";import{c as H}from"./Cibw3ATY.js";import{S as He}from"./CpSN0xDf.js";import{C as Oe}from"./BhgzBv2L.js";import"./CkYB-R1u.js";import"./c5FhCeC0.js";const qe=H("bell-ring",[["path",{d:"M10.268 21a2 2 0 0 0 3.464 0",key:"vwvbt9"}],["path",{d:"M22 8c0-2.3-.8-4.3-2-6",key:"5bb3ad"}],["path",{d:"M3.262 15.326A1 1 0 0 0 4 17h16a1 1 0 0 0 .74-1.673C19.41 13.956 18 12.499 18 8A6 6 0 0 0 6 8c0 4.499-1.411 5.956-2.738 7.326",key:"11g9vi"}],["path",{d:"M4 2C2.8 3.7 2 5.7 2 8",key:"tap9e0"}]]);const Ee=H("chevron-left",[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]]);const Xe=H("gift",[["rect",{x:"3",y:"8",width:"18",height:"4",rx:"1",key:"bkv52"}],["path",{d:"M12 8v13",key:"1c76mn"}],["path",{d:"M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7",key:"6wjy6b"}],["path",{d:"M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5",key:"1ihvrl"}]]);const Ke=H("refresh-cw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]),Qe={class:"space-y-6"},We={class:"rounded-2xl border border-border bg-card p-6 shadow-sm"},Je={class:"flex flex-wrap items-start justify-between gap-4"},Ye={class:"space-y-1"},Ze={class:"text-2xl font-bold text-foreground"},et={class:"text-sm text-muted-foreground"},tt={class:"flex flex-wrap items-center gap-2"},st={class:"rounded-2xl border border-border bg-card p-6 shadow-sm"},lt={class:"flex flex-wrap items-center justify-between gap-4"},at={class:"flex flex-1 flex-wrap items-center gap-3"},ot={class:"relative w-full max-w-md"},nt={class:"flex flex-wrap items-center gap-2"},rt={class:"ml-2 rounded-full bg-background px-2 py-0.5 text-[11px] text-muted-foreground"},it={class:"ml-2 rounded-full bg-background px-2 py-0.5 text-[11px] text-muted-foreground"},ut={class:"ml-2 rounded-full bg-background px-2 py-0.5 text-[11px] text-muted-foreground"},dt={class:"ml-2 rounded-full bg-background px-2 py-0.5 text-[11px] text-muted-foreground"},ft={class:"mt-4 flex flex-wrap items-center justify-between gap-3 rounded-xl border border-border/70 bg-muted/20 px-4 py-3"},ct={class:"text-sm text-muted-foreground"},mt={class:"font-semibold text-foreground"},pt={class:"flex flex-wrap items-center gap-2"},vt={key:0,class:"mt-3 text-sm text-emerald-600"},xt={class:"mt-6 rounded-2xl border border-border bg-background"},gt=["checked","indeterminate","aria-label"],bt=["checked","aria-label","onChange"],yt={class:"flex items-center gap-3"},_t={class:"space-y-0.5"},ht={class:"text-sm font-semibold text-foreground"},wt={class:"text-xs text-muted-foreground"},kt={class:"flex items-center gap-2"},Ct={class:"text-sm font-semibold text-foreground"},Tt={class:"mt-6 flex flex-wrap items-center justify-between gap-3"},Vt={class:"text-sm text-muted-foreground"},Mt={class:"flex items-center gap-2"},Pt={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 px-4"},St={class:"w-full max-w-lg rounded-2xl border border-border bg-card p-6 shadow-2xl"},zt={class:"flex items-start justify-between gap-4"},Lt={class:"text-sm text-muted-foreground"},At={class:"mt-4"},Nt={class:"mt-5 flex flex-wrap justify-end gap-2"},Rt={key:1,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 px-4"},Bt={class:"w-full max-w-lg rounded-2xl border border-border bg-card p-6 shadow-2xl"},jt={class:"flex items-start justify-between gap-4"},It={class:"text-sm text-muted-foreground"},Ut={class:"mt-4 space-y-3"},Dt={class:"mt-5 flex flex-wrap justify-end gap-2"},G=20,rs=Se({__name:"index",setup(Ft){const te=ze(),{user:O}=Le(te),m=f(0),L=f(""),A=f(""),x=f("all"),u=f([]),N=f(""),q=f(!1),b=f(!1),y=f(""),E=f(!1),_=f(!1),h=f("Подарочный билет"),R=f("");let T=null,V=null;ee(L,l=>{T&&clearTimeout(T),T=setTimeout(()=>{A.value=l.trim().toLowerCase(),m.value=0,u.value=[]},300)});const de=()=>te.apiFetch("/api/v1/organizer/audience",{baseURL:Ne("/api/v1/organizer/audience"),query:{limit:G,offset:m.value*G,sort_by:"ltv"}}),fe=d(()=>`organizer-audience-${m.value}`),{data:B,pending:se,refresh:ce}=Ge(fe,de,{default:()=>({items:[],total:0,total_ltv:0,avg_loyalty:0}),watch:[m]}),w=d(()=>B.value?.items??[]),X=l=>l.ltv>1e4,le=l=>(l.events_attended??0)===1,ae=l=>{if(!l.last_interaction_at)return!0;const e=new Date(l.last_interaction_at).getTime();return Number.isNaN(e)?!0:(Date.now()-e)/(1e3*60*60*24)>=90},j=d(()=>{let l=[...w.value];return A.value&&(l=l.filter(e=>{const a=e.user.full_name||"",Z=e.user.username||"";return a.toLowerCase().includes(A.value)||Z.toLowerCase().includes(A.value)})),x.value==="vip"?l=l.filter(X):x.value==="new"?l=l.filter(le):x.value==="lost"&&(l=l.filter(ae)),l.sort((e,a)=>e.ltv!==a.ltv?a.ltv-e.ltv:e.user.id-a.user.id),l}),M=d(()=>j.value.map(l=>l.user.id)),me=d(()=>M.value.some(l=>u.value.includes(l))),K=d(()=>M.value.length>0&&M.value.every(l=>u.value.includes(l))),pe=d(()=>me.value&&!K.value),ve=d(()=>j.value.filter(l=>u.value.includes(l.user.id))),v=d(()=>ve.value.length),I=d(()=>({all:w.value.length,vip:w.value.filter(X).length,new:w.value.filter(le).length,lost:w.value.filter(ae).length}));ee(w,l=>{const e=new Set(l.map(a=>a.user.id));u.value=u.value.filter(a=>e.has(a))}),ee(m,()=>{u.value=[]});const U=l=>{x.value=l,u.value=[]},xe=l=>{if(!l){u.value=u.value.filter(a=>!M.value.includes(a));return}const e=new Set(u.value);for(const a of M.value)e.add(a);u.value=[...e]},ge=(l,e)=>{if(e){u.value.includes(l)||(u.value=[...u.value,l]);return}u.value=u.value.filter(a=>a!==l)},P=l=>{N.value=l,V&&clearTimeout(V),V=setTimeout(()=>{N.value=""},3e3)},oe=d(()=>{const l=(O.value?.role??"").toLowerCase();return l?!["viewer","guest","readonly"].includes(l):!0}),be=()=>{if(!v.value){P("Выберите хотя бы одного участника.");return}if(!oe.value){P("У вас нет прав на отправку Push.");return}y.value="",q.value=!0},Q=()=>{b.value||(q.value=!1,y.value="")},ye=async()=>{if(y.value.trim()){b.value=!0;try{await new Promise(e=>setTimeout(e,650)),P(`Push отправлен: ${v.value} получател(ям).`),u.value=[],Q()}finally{b.value=!1}}},_e=()=>{if(!v.value){P("Выберите хотя бы одного участника.");return}h.value="Подарочный билет",R.value="",E.value=!0},W=()=>{_.value||(E.value=!1)},he=async()=>{if(h.value.trim()){_.value=!0;try{await new Promise(e=>setTimeout(e,650)),P(`Gift Ticket отправлен: ${v.value} получател(ям).`),u.value=[],W()}finally{_.value=!1}}},J=d(()=>B.value?.total??0),we=d(()=>Math.max(1,Math.ceil(J.value/G))),ke=d(()=>m.value>0),Ce=d(()=>(m.value+1)*G<J.value),Te=d(()=>O.value?.full_name||O.value?.username||"организатор"),Ve=d(()=>(B.value?.items??[]).length===0?"Аудитория пока пустая.":"По текущим фильтрам нет участников."),Y=new Intl.NumberFormat("ru-RU"),Me=new Intl.NumberFormat("ru-RU",{style:"currency",currency:"RUB",maximumFractionDigits:0}),ne=l=>Me.format(Math.round(l||0)),Pe=l=>l?l.split(" ").map(e=>e.trim().charAt(0)).filter(Boolean).slice(0,2).join("").toUpperCase():"SE";return Ae(()=>{T&&clearTimeout(T),V&&clearTimeout(V)}),(l,e)=>(p(),S("div",Qe,[s("section",We,[s("div",Je,[s("div",Ye,[e[11]||(e[11]=s("p",{class:"text-xs font-semibold uppercase tracking-[0.3em] text-muted-foreground"},"Audience CRM",-1)),s("h1",Ze,"Привет, "+i(t(Te)),1),s("p",et," CRM-аудитория организатора. Всего участников: "+i(t(Y).format(t(J)))+". ",1)]),s("div",tt,[o(t(ue),{variant:"secondary",class:"px-4 py-2 text-sm"},{default:n(()=>[r(" Total LTV: "+i(ne(t(B)?.total_ltv??0)),1)]),_:1}),o(t(c),{variant:"outline",size:"sm",class:"gap-2",disabled:t(se),onClick:t(ce)},{default:n(()=>[o(t(Ke),{class:"h-4 w-4"}),e[12]||(e[12]=r(" Обновить ",-1))]),_:1},8,["disabled","onClick"])])])]),s("section",st,[s("div",lt,[s("div",at,[s("div",ot,[o(t(He),{class:"pointer-events-none absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),o(t(re),{modelValue:t(L),"onUpdate:modelValue":e[0]||(e[0]=a=>D(L)?L.value=a:null),class:"h-11 pl-10",placeholder:"Поиск по имени или username"},null,8,["modelValue"])]),s("div",nt,[s("button",{class:F(["inline-flex items-center rounded-full px-4 py-2 text-xs font-semibold transition",t(x)==="all"?"bg-primary/10 text-primary":"text-muted-foreground hover:text-foreground"]),onClick:e[1]||(e[1]=a=>U("all"))},[e[13]||(e[13]=r(" Все ",-1)),s("span",rt,i(t(I).all),1)],2),s("button",{class:F(["inline-flex items-center rounded-full px-4 py-2 text-xs font-semibold transition",t(x)==="vip"?"bg-primary/10 text-primary":"text-muted-foreground hover:text-foreground"]),onClick:e[2]||(e[2]=a=>U("vip"))},[e[14]||(e[14]=r(" VIP ",-1)),s("span",it,i(t(I).vip),1)],2),s("button",{class:F(["inline-flex items-center rounded-full px-4 py-2 text-xs font-semibold transition",t(x)==="new"?"bg-primary/10 text-primary":"text-muted-foreground hover:text-foreground"]),onClick:e[3]||(e[3]=a=>U("new"))},[e[15]||(e[15]=r(" Новички ",-1)),s("span",ut,i(t(I).new),1)],2),s("button",{class:F(["inline-flex items-center rounded-full px-4 py-2 text-xs font-semibold transition",t(x)==="lost"?"bg-primary/10 text-primary":"text-muted-foreground hover:text-foreground"]),onClick:e[4]||(e[4]=a=>U("lost"))},[e[16]||(e[16]=r(" Потерянные ",-1)),s("span",dt,i(t(I).lost),1)],2)])])]),s("div",ft,[s("p",ct,[e[17]||(e[17]=r(" Выбрано участников: ",-1)),s("span",mt,i(t(v)),1)]),s("div",pt,[t(oe)?(p(),z(t(c),{key:0,variant:"outline",size:"sm",class:"gap-2",disabled:t(v)===0,onClick:be},{default:n(()=>[o(t(qe),{class:"h-4 w-4"}),e[18]||(e[18]=r(" Отправить Push ",-1))]),_:1},8,["disabled"])):k("",!0),o(t(c),{variant:"default",size:"sm",class:"gap-2",disabled:t(v)===0,onClick:_e},{default:n(()=>[o(t(Xe),{class:"h-4 w-4"}),e[19]||(e[19]=r(" Подарить Билет ",-1))]),_:1},8,["disabled"])])]),t(N)?(p(),S("p",vt,i(t(N)),1)):k("",!0),s("div",xt,[o(t(je),null,{default:n(()=>[o(t(Ie),null,{default:n(()=>[o(t($),null,{default:n(()=>[o(t(C),{class:"w-10"},{default:n(()=>[s("input",{type:"checkbox",class:"h-4 w-4 accent-primary",checked:t(K),indeterminate:t(pe),"aria-label":t(K)?"Снять выбор":"Выбрать всех",onChange:e[5]||(e[5]=a=>xe(a.target.checked))},null,40,gt)]),_:1}),o(t(C),null,{default:n(()=>[...e[20]||(e[20]=[r("Пользователь",-1)])]),_:1}),o(t(C),null,{default:n(()=>[...e[21]||(e[21]=[r("Уровень XP",-1)])]),_:1}),o(t(C),null,{default:n(()=>[...e[22]||(e[22]=[r("Посещено событий",-1)])]),_:1}),o(t(C),{class:"text-right"},{default:n(()=>[...e[23]||(e[23]=[r("Потрачено (LTV)",-1)])]),_:1}),o(t(C),{class:"text-right"},{default:n(()=>[...e[24]||(e[24]=[r("Привел друзей",-1)])]),_:1})]),_:1})]),_:1}),o(t(Ue),null,{default:n(()=>[t(se)?(p(),z(t($),{key:0},{default:n(()=>[o(t(g),{colspan:"6",class:"py-10 text-center text-sm text-muted-foreground"},{default:n(()=>[...e[25]||(e[25]=[r(" Загружаем аудиторию... ",-1)])]),_:1})]),_:1})):t(j).length===0?(p(),z(t($),{key:1},{default:n(()=>[o(t(g),{colspan:"6",class:"py-10 text-center text-sm text-muted-foreground"},{default:n(()=>[r(i(t(Ve)),1)]),_:1})]),_:1})):k("",!0),(p(!0),S(Re,null,Be(t(j),a=>(p(),z(t($),{key:a.user.id},{default:n(()=>[o(t(g),null,{default:n(()=>[s("input",{type:"checkbox",class:"h-4 w-4 accent-primary",checked:t(u).includes(a.user.id),"aria-label":`Выбрать ${a.user.username}`,onChange:Z=>ge(a.user.id,Z.target.checked)},null,40,bt)]),_:2},1024),o(t(g),null,{default:n(()=>[s("div",yt,[o(t(De),{class:"h-10 w-10"},{default:n(()=>[o(t(Fe),{src:a.user.avatar_url||""},null,8,["src"]),o(t($e),{class:"bg-primary/10 font-semibold text-primary"},{default:n(()=>[r(i(Pe(a.user.full_name||a.user.username)),1)]),_:2},1024)]),_:2},1024),s("div",_t,[s("p",ht,i(a.user.full_name||a.user.username),1),s("p",wt,"@"+i(a.user.username),1)])])]),_:2},1024),o(t(g),null,{default:n(()=>[s("div",kt,[s("span",Ct,"LVL "+i(a.user.level),1),X(a)?(p(),z(t(ue),{key:0,variant:"default"},{default:n(()=>[...e[26]||(e[26]=[r("VIP",-1)])]),_:1})):k("",!0)])]),_:2},1024),o(t(g),{class:"font-semibold text-foreground"},{default:n(()=>[r(i(t(Y).format(a.events_attended)),1)]),_:2},1024),o(t(g),{class:"text-right font-semibold text-foreground"},{default:n(()=>[r(i(ne(a.ltv)),1)]),_:2},1024),o(t(g),{class:"text-right font-semibold text-foreground"},{default:n(()=>[r(i(t(Y).format(a.influence_score)),1)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),s("div",Tt,[s("p",Vt," Страница "+i(t(m)+1)+" из "+i(t(we)),1),s("div",Mt,[o(t(c),{variant:"outline",size:"sm",class:"gap-2",disabled:!t(ke),onClick:e[6]||(e[6]=a=>m.value--)},{default:n(()=>[o(t(Ee),{class:"h-4 w-4"}),e[27]||(e[27]=r(" Назад ",-1))]),_:1},8,["disabled"]),o(t(c),{variant:"outline",size:"sm",class:"gap-2",disabled:!t(Ce),onClick:e[7]||(e[7]=a=>m.value++)},{default:n(()=>[e[28]||(e[28]=r(" Вперед ",-1)),o(t(Oe),{class:"h-4 w-4"})]),_:1},8,["disabled"])])])]),t(q)?(p(),S("div",Pt,[s("div",St,[s("div",zt,[s("div",null,[e[29]||(e[29]=s("h3",{class:"text-lg font-semibold text-foreground"},"Отправить Push",-1)),s("p",Lt," Получателей: "+i(t(v)),1)]),o(t(c),{variant:"ghost",size:"sm",disabled:t(b),onClick:Q},{default:n(()=>[...e[30]||(e[30]=[r("Закрыть",-1)])]),_:1},8,["disabled"])]),s("div",At,[e[31]||(e[31]=s("label",{class:"text-xs font-semibold uppercase tracking-[0.2em] text-muted-foreground"}," Сообщение ",-1)),o(t(ie),{modelValue:t(y),"onUpdate:modelValue":e[8]||(e[8]=a=>D(y)?y.value=a:null),placeholder:"Например: Мы подготовили для вас специальное предложение."},null,8,["modelValue"])]),s("div",Nt,[o(t(c),{variant:"outline",disabled:t(b),onClick:Q},{default:n(()=>[...e[32]||(e[32]=[r(" Отмена ",-1)])]),_:1},8,["disabled"]),o(t(c),{disabled:t(b)||!t(y).trim(),onClick:ye},{default:n(()=>[r(i(t(b)?"Отправляем...":"Отправить Push"),1)]),_:1},8,["disabled"])])])])):k("",!0),t(E)?(p(),S("div",Rt,[s("div",Bt,[s("div",jt,[s("div",null,[e[33]||(e[33]=s("h3",{class:"text-lg font-semibold text-foreground"},"Gift Ticket",-1)),s("p",It," Получателей: "+i(t(v)),1)]),o(t(c),{variant:"ghost",size:"sm",disabled:t(_),onClick:W},{default:n(()=>[...e[34]||(e[34]=[r("Закрыть",-1)])]),_:1},8,["disabled"])]),s("div",Ut,[s("div",null,[e[35]||(e[35]=s("label",{class:"text-xs font-semibold uppercase tracking-[0.2em] text-muted-foreground"}," Название билета ",-1)),o(t(re),{modelValue:t(h),"onUpdate:modelValue":e[9]||(e[9]=a=>D(h)?h.value=a:null),placeholder:"Например, VIP-приглашение"},null,8,["modelValue"])]),s("div",null,[e[36]||(e[36]=s("label",{class:"text-xs font-semibold uppercase tracking-[0.2em] text-muted-foreground"}," Сообщение ",-1)),o(t(ie),{modelValue:t(R),"onUpdate:modelValue":e[10]||(e[10]=a=>D(R)?R.value=a:null),placeholder:"Например: До встречи на следующем событии!"},null,8,["modelValue"])])]),s("div",Dt,[o(t(c),{variant:"outline",disabled:t(_),onClick:W},{default:n(()=>[...e[37]||(e[37]=[r(" Отмена ",-1)])]),_:1},8,["disabled"]),o(t(c),{disabled:t(_)||!t(h).trim(),onClick:he},{default:n(()=>[r(i(t(_)?"Отправляем...":"Подарить Билет"),1)]),_:1},8,["disabled"])])])])):k("",!0)]))}});export{rs as default};
