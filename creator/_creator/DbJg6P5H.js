import{b as Lt,u as Tt,a1 as Ft,C as c,D as a,M as l,R as o,N as m,O as _,U as P,V as B,S as z,a2 as v,t as r,B as i,P as b,n as y,I as Q,X as U,W as Nt,aj as Rt}from"./Ca6rub8f.js";import k from"./Bc1u1-yo.js";import{u as f}from"./B-wzc82F.js";import{c as I}from"./Cibw3ATY.js";import{R as $t}from"./NezAEcU6.js";import"./CkYB-R1u.js";import"./c5FhCeC0.js";const Et=I("calendar-plus",[["path",{d:"M16 19h6",key:"xwg31i"}],["path",{d:"M16 2v4",key:"4m81vk"}],["path",{d:"M19 16v6",key:"tddt3s"}],["path",{d:"M21 12.598V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8.5",key:"1glfrc"}],["path",{d:"M3 10h18",key:"8toen8"}],["path",{d:"M8 2v4",key:"1cmpym"}]]);const Pt=I("flame",[["path",{d:"M12 3q1 4 4 6.5t3 5.5a1 1 0 0 1-14 0 5 5 0 0 1 1-3 1 1 0 0 0 5 0c0-2-1.5-3-1.5-5q0-2 2.5-4",key:"1slcih"}]]);const Bt=I("message-circle",[["path",{d:"M2.992 16.342a2 2 0 0 1 .094 1.167l-1.065 3.29a1 1 0 0 0 1.236 1.168l3.413-.998a2 2 0 0 1 1.099.092 10 10 0 1 0-4.777-4.719",key:"1sd12s"}]]),Ut={class:"space-y-6"},It={class:"flex flex-wrap items-center justify-between gap-4 rounded-2xl border border-border bg-card p-6 shadow-sm"},jt={class:"space-y-1"},At={class:"text-2xl font-bold text-foreground"},Vt={class:"text-sm text-muted-foreground"},Ot={class:"grid gap-4 sm:grid-cols-2 xl:grid-cols-4"},qt={class:"text-xs font-semibold uppercase tracking-[0.2em] text-muted-foreground"},Ht={class:"mt-2 text-2xl font-bold text-foreground"},Kt={class:"mt-4 rounded-xl border border-border/70 bg-background/60 p-2"},Jt={viewBox:"0 0 100 30",class:"h-12 w-full"},Wt=["points"],Xt={class:"text-[11px] font-medium text-muted-foreground"},Gt={key:0,class:"rounded-2xl border border-rose-200 bg-gradient-to-r from-rose-50 via-white to-red-50 p-6 shadow-sm"},Qt={class:"flex flex-wrap items-center justify-between gap-4"},Yt={class:"space-y-1"},Zt={class:"text-xl font-bold text-rose-900"},te={class:"text-sm font-semibold text-rose-700"},ee={class:"grid gap-4 lg:grid-cols-[minmax(0,2fr)_minmax(0,1fr)]"},se={class:"rounded-2xl border border-border bg-card p-5 shadow-sm"},ae={class:"flex items-center justify-between"},re={class:"mt-4 overflow-x-auto"},ne={class:"w-full min-w-[680px] text-sm"},oe={key:0,class:"border-b border-border/70"},le={key:1,class:"border-b border-border/70"},ie={class:"py-4 pr-4"},de={class:"space-y-1"},ce={class:"font-semibold text-foreground"},ue={class:"py-4 pr-4 text-muted-foreground"},me={class:"py-4 pr-4"},pe={class:"space-y-2"},ve={class:"h-2 w-full rounded-full bg-muted"},be={class:"text-xs text-muted-foreground"},fe={key:0,class:"ml-1"},ge={class:"py-4"},he={class:"flex gap-2"},xe={class:"rounded-2xl border border-border bg-card p-5 shadow-sm"},_e={class:"mt-4 space-y-3"},ye={class:"flex items-start gap-3"},ke={class:"mt-0.5"},we={class:"text-sm font-semibold text-foreground"},Ce={class:"mt-1 text-xs text-muted-foreground"},Me={key:0,class:"mt-4 text-xs text-muted-foreground"},$e=Lt({__name:"index",setup(ze){const u=Tt(),{user:j}=Ft(u),Y=r(()=>j.value?.full_name||j.value?.username||"организатор"),Z=r(()=>`Добро пожаловать, ${Y.value}`),tt=new Intl.NumberFormat("ru-RU"),et=new Intl.NumberFormat("ru-RU",{style:"currency",currency:"RUB",maximumFractionDigits:0}),st=new Intl.DateTimeFormat("ru-RU",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}),A=t=>et.format(Math.round(t)),p=t=>tt.format(Math.round(t)),V=t=>{if(!t)return"Дата уточняется";const e=new Date(t);return Number.isNaN(e.getTime())?"Дата уточняется":st.format(e)},g=t=>{if(!t)return 0;const e=Date.parse(t);return Number.isNaN(e)?0:e},S=t=>{const e=(t.occurrences??[]).map(s=>g(s.start_time)).filter(s=>s>0);return e.length?Math.min(...e):g(t.created_at)},O=t=>{const e=(t.occurrences??[]).map(s=>g(s.start_time)).filter(s=>s>0);return e.length?Math.max(...e):g(t.created_at)},at=t=>{const e=(t.occurrences??[]).map(s=>g(s.start_time)).filter(s=>s>0).sort((s,n)=>s-n);return e.length?V(new Date(e[0]).toISOString()):V(t.created_at)},w=(t,e)=>{const s=Math.max(1,t/7),n=[.74,.79,.85,.9,.96,1.03,1.1],d=(e%5-2)*.01;return n.map((x,$)=>{const E=$%2===0?1:-1;return Math.max(1,Math.round(s*(x+d*E)))})},rt=t=>{if(!t.length)return"";const e=Math.max(...t,1),s=Math.min(...t),n=Math.max(e-s,1);return t.map((d,x)=>{const $=x/Math.max(t.length-1,1)*100,E=28-(d-s)/n*22;return`${$},${E}`}).join(" ")},nt=t=>t==="draft"?"Draft":t==="scheduled"?"Published":t,ot=t=>t==="draft"?"bg-amber-500/10 text-amber-700":t==="scheduled"?"bg-emerald-500/10 text-emerald-700":"bg-muted text-muted-foreground",lt=t=>{const e=(t.tickets??[]).reduce((n,d)=>n+(d.sold??0),0),s=(t.tickets??[]).reduce((n,d)=>n+(d.capacity??0),0);return{sold:e,capacity:s>0?s:null}},{data:it,pending:dt}=f("organizer-dashboard-events",()=>u.apiFetch("/api/v1/events/",{baseURL:v("/api/v1/events"),query:{limit:50}}),{default:()=>[]}),{data:ct}=f("organizer-dashboard-demand",()=>u.apiFetch("/api/v1/organizer/demand",{baseURL:v("/api/v1/organizer/demand")}),{default:()=>({waiting_count:0,recent_waiting_count:0,top_users:[]})}),{data:ut}=f("organizer-dashboard-summary",async()=>{try{return await u.apiFetch("/api/v1/organizer/dashboard/stats",{baseURL:v("/api/v1/organizer/dashboard/stats")})}catch{return null}},{default:()=>null}),q=r(()=>it.value??[]),mt=r(()=>ct.value),D=r(()=>ut.value),H=r(()=>[...q.value].sort((t,e)=>S(t)-S(e))),K=r(()=>[...q.value].sort((t,e)=>O(e)-O(t))),J=r(()=>{const t=Date.now();return H.value.filter(e=>S(e)>=t)}),L=r(()=>K.value[0]??null),h=r(()=>L.value?.id??0),T=r(()=>K.value.slice(0,5)),F=r(()=>J.value.length?J.value.slice(0,5):H.value.slice(0,5)),pt=r(()=>F.value.map(t=>t.id).join(",")),vt=r(()=>T.value.map(t=>t.id).join(",")),{data:bt,pending:ft}=f("organizer-dashboard-context-stats",async()=>{if(!h.value)return null;try{return await u.apiFetch(`/api/v1/organizer/events/${h.value}/stats`,{baseURL:v("/api/v1/organizer/events")})}catch{return null}},{watch:[h],default:()=>null}),{data:gt}=f("organizer-dashboard-live-pulse",async()=>{if(!T.value.length)return null;const t=await Promise.all(T.value.map(async n=>{try{return await u.apiFetch(`/api/v1/organizer/events/${n.id}/dashboard-stats`,{baseURL:v("/api/v1/organizer/events")})}catch{return null}})),e=t.find(n=>!!n&&n.current_mode==="live");return e||(t.find(n=>!!n)??null)},{watch:[vt],default:()=>null}),{data:ht,pending:xt}=f("organizer-dashboard-upcoming-stats",async()=>(await Promise.all(F.value.map(async e=>{try{const s=await u.apiFetch(`/api/v1/organizer/events/${e.id}/stats`,{baseURL:v("/api/v1/organizer/events")});return[e.id,s]}catch{return[e.id,null]}}))).reduce((e,[s,n])=>(n&&(e[s]=n),e),{}),{watch:[pt],default:()=>({})}),C=r(()=>bt.value),N=r(()=>gt.value),_t=r(()=>ht.value??{}),R=r(()=>D.value?.revenue_total??C.value?.revenue??0),W=r(()=>C.value?.tickets_sold??D.value?.tickets_sold??0),M=r(()=>D.value?.users_total??C.value?.view_count??0),X=r(()=>M.value?R.value/M.value:0),yt=r(()=>[{label:"Выручка за месяц",value:A(R.value),hint:"Тренд за 7 дней",trendSeries:w(R.value,11),trendColor:"#10b981"},{label:"Продано билетов",value:p(W.value),hint:"Тренд за 7 дней",trendSeries:w(W.value,23),trendColor:"#3b82f6"},{label:"Подписчиков",value:p(M.value),hint:"Тренд за 7 дней",trendSeries:w(M.value,37),trendColor:"#f59e0b"},{label:"LTV аудитории",value:A(X.value),hint:"Тренд за 7 дней",trendSeries:w(X.value,41),trendColor:"#ef4444"}]),kt=r(()=>N.value?.current_mode==="live"),wt=r(()=>N.value?.event_title||L.value?.title||"Текущее событие"),Ct=r(()=>N.value?.visitors_now??C.value?.check_in_count??0),G=r(()=>F.value.map(t=>{const e=_t.value[t.id],s=lt(t),n=e?.tickets_sold??s.sold,d=e?.total_capacity??s.capacity,x=d&&d>0?Math.min(100,Math.round(n/d*100)):0;return{id:t.id,title:t.title,statusLabel:nt(t.status),statusClass:ot(t.status),dateLabel:at(t),sold:n,capacity:d,progress:x}})),Mt=r(()=>[{key:"demand",title:"Высокий спрос на 'Jazz Night'!",description:`${p(mt.value?.waiting_count??0)} человек уже ждут запуск продаж.`,icon:Pt,cardClass:"border-amber-200 bg-amber-50",iconClass:"text-amber-600"},{key:"mention",title:"Вас упомянули в сторис",description:"Проверьте новые отметки и усилите охват репостом.",icon:Bt,cardClass:"border-sky-200 bg-sky-50",iconClass:"text-sky-600"}]),zt=()=>{h.value&&y(`/events/${h.value}/live`)},St=t=>{y(`/events/${t}`)},Dt=t=>{y(`/events/${t}/live`)};return(t,e)=>(i(),c("div",Ut,[a("section",It,[a("div",jt,[e[2]||(e[2]=a("p",{class:"text-xs font-semibold uppercase tracking-[0.3em] text-muted-foreground"},"Organizer Hub",-1)),a("h2",At,l(o(Z)),1),a("p",Vt," Текущий контекст: "+l(o(L)?.title||"выберите событие")+". ",1)]),m(o(k),{class:"gap-2",onClick:e[0]||(e[0]=s=>("navigateTo"in t?t.navigateTo:o(y))("/events"))},{default:_(()=>[m(o(Et),{class:"h-4 w-4"}),e[3]||(e[3]=b(" Создать событие ",-1))]),_:1})]),a("section",Ot,[(i(!0),c(P,null,B(o(yt),s=>(i(),c("article",{key:s.label,class:"rounded-2xl border border-border bg-card p-5 shadow-sm"},[a("p",qt,l(s.label),1),a("p",Ht,l(s.value),1),a("div",Kt,[(i(),c("svg",Jt,[a("polyline",{points:rt(s.trendSeries),fill:"none","stroke-width":"2.5","stroke-linecap":"round","stroke-linejoin":"round",style:Q({stroke:s.trendColor})},null,12,Wt)])),a("p",Xt,l(s.hint),1)])]))),128))]),o(kt)?(i(),c("section",Gt,[a("div",Qt,[a("div",Yt,[e[4]||(e[4]=a("p",{class:"text-xs font-semibold uppercase tracking-[0.2em] text-rose-600"},"Live Pulse",-1)),a("h3",Zt,'Ивент "'+l(o(wt))+'" идет прямо сейчас',1),a("p",te,"Людей внутри: "+l(p(o(Ct))),1)]),m(o(k),{class:"gap-2",onClick:zt},{default:_(()=>[m(o($t),{class:"h-4 w-4"}),e[5]||(e[5]=b(" Перейти в Пульт Управления ",-1))]),_:1})])])):z("",!0),a("section",ee,[a("div",se,[a("div",ae,[e[7]||(e[7]=a("h3",{class:"text-lg font-semibold text-foreground"},"Ближайшие события",-1)),m(o(k),{variant:"outline",size:"sm",onClick:e[1]||(e[1]=s=>("navigateTo"in t?t.navigateTo:o(y))("/events"))},{default:_(()=>[...e[6]||(e[6]=[b("Все события",-1)])]),_:1})]),a("div",re,[a("table",ne,[e[12]||(e[12]=a("thead",null,[a("tr",{class:"border-b border-border text-left text-xs uppercase tracking-[0.18em] text-muted-foreground"},[a("th",{class:"pb-3 pr-4 font-semibold"},"Статус"),a("th",{class:"pb-3 pr-4 font-semibold"},"Дата"),a("th",{class:"pb-3 pr-4 font-semibold"},"Продажи"),a("th",{class:"pb-3 font-semibold"},"Действия")])],-1)),a("tbody",null,[o(dt)?(i(),c("tr",oe,[...e[8]||(e[8]=[a("td",{colspan:"4",class:"py-4 text-sm text-muted-foreground"},"Загружаем события...",-1)])])):o(G).length?z("",!0):(i(),c("tr",le,[...e[9]||(e[9]=[a("td",{colspan:"4",class:"py-4 text-sm text-muted-foreground"},"Пока нет событий в расписании.",-1)])])),(i(!0),c(P,null,B(o(G),s=>(i(),c("tr",{key:s.id,class:"border-b border-border/70 align-top last:border-b-0"},[a("td",ie,[a("div",de,[a("p",ce,l(s.title),1),a("span",{class:U(["inline-flex rounded-full px-2 py-1 text-xs font-semibold",s.statusClass])},l(s.statusLabel),3)])]),a("td",ue,l(s.dateLabel),1),a("td",me,[a("div",pe,[a("div",ve,[a("div",{class:"h-full rounded-full bg-primary",style:Q({width:`${s.progress}%`})},null,4)]),a("p",be,[b(l(p(s.sold))+" / "+l(s.capacity?p(s.capacity):"—")+" ",1),o(xt)?(i(),c("span",fe,"• обновляем")):z("",!0)])])]),a("td",ge,[a("div",he,[m(o(k),{size:"sm",variant:"outline",onClick:n=>St(s.id)},{default:_(()=>[...e[10]||(e[10]=[b("Edit",-1)])]),_:1},8,["onClick"]),m(o(k),{size:"sm",onClick:n=>Dt(s.id)},{default:_(()=>[...e[11]||(e[11]=[b("Manage",-1)])]),_:1},8,["onClick"])])])]))),128))])])])]),a("aside",xe,[e[13]||(e[13]=a("p",{class:"text-xs font-semibold uppercase tracking-[0.2em] text-muted-foreground"},"Action Center",-1)),a("div",_e,[(i(!0),c(P,null,B(o(Mt),s=>(i(),c("div",{key:s.key,class:U(["rounded-xl border p-3",s.cardClass])},[a("div",ye,[a("div",ke,[(i(),Nt(Rt(s.icon),{class:U(["h-4 w-4",s.iconClass])},null,8,["class"]))]),a("div",null,[a("p",we,l(s.title),1),a("p",Ce,l(s.description),1)])])],2))),128))]),o(ft)?(i(),c("p",Me,"Обновляем статистику...")):z("",!0)])])]))}});export{$e as default};
