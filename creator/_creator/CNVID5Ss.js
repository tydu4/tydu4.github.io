import{b as Le,u as Re,G as Ve,o as Ae,h as Fe,C as y,D as a,N as n,O as o,R as s,Q as j,U as ee,V as te,M as u,S as O,l as d,a2 as z,B as f,P as r,X as Be,W as q,F as Ee,t as _,n as H}from"./D9Gj93nn.js";import U from"./BTl0NxUM.js";import ze from"./CFXH2yXk.js";import Ie from"./96D5_NCN.js";import Me from"./VAQOpaum.js";import Ne from"./BVa6hkJI.js";import Pe from"./Dhb3ZzrZ.js";import je from"./kadCuyyv.js";import I from"./DZ5wyupk.js";import x from"./CY4osaut.js";import m from"./zCv1LKEW.js";import Oe from"./DBFLbal6.js";import qe from"./Y7r-k2LO.js";import He from"./Dl-X0CC4.js";import Ge from"./D_hdh7AO.js";import{u as Qe}from"./Dg2pdhbl.js";import{P as We,C as Xe}from"./oddCwiQW.js";import{S as Je}from"./0fNVaIic.js";import{c as Ke}from"./ZqIlnLQN.js";import"./CkYB-R1u.js";import"./c5FhCeC0.js";const Ye=Ke("ellipsis",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]]),Ze={class:"space-y-6"},et={class:"rounded-2xl border border-border bg-card p-6 shadow-sm"},tt={class:"flex flex-wrap items-center justify-between gap-4"},st={class:"rounded-2xl border border-border bg-card p-6 shadow-sm"},lt={class:"flex flex-wrap items-center justify-between gap-4"},at={class:"flex flex-1 flex-wrap items-center gap-3"},nt={class:"relative w-full max-w-md"},ot={class:"flex flex-wrap items-center gap-2"},rt=["onClick"],ut={class:"ml-2 rounded-full bg-background px-2 py-0.5 text-[11px] text-muted-foreground"},it={class:"mt-3 flex flex-wrap items-center justify-between gap-2 text-xs text-muted-foreground"},dt={key:0,class:"mt-3 text-sm text-emerald-600"},ct={class:"mt-5 rounded-2xl border border-border bg-background"},ft={class:"flex items-center gap-3"},mt={class:"space-y-0.5"},pt={class:"text-sm font-semibold text-foreground"},gt={class:"text-xs text-muted-foreground"},vt={class:"text-sm font-medium text-foreground"},xt={class:"text-xs text-muted-foreground"},bt={class:"truncate text-sm text-foreground"},yt={class:"relative inline-flex","data-row-menu-root":""},_t={key:0,class:"absolute right-0 z-30 mt-2 w-52 rounded-xl border border-border bg-background p-2 shadow-xl"},ht=["onClick"],kt=["onClick"],Ct=["disabled","onClick"],Tt=["disabled","onClick"],wt={class:"space-y-4"},Dt={class:"space-y-1"},St={class:"text-sm text-muted-foreground"},Ut={class:"font-semibold text-foreground"},$t={class:"space-y-2"},Lt={class:"flex flex-wrap justify-end gap-2"},Zt=Le({__name:"index",setup(Rt){const $=Re(),L=d(""),G=d(""),M=d("all"),R=d("desc"),h=d(null),V=d(null),k=d(!1),p=d(null),v=d(""),g=d(!1),A=d("");let C=null,T=null;Ve(L,e=>{C&&clearTimeout(C),C=setTimeout(()=>{G.value=e.trim().toLowerCase()},250)});const{data:se,pending:le,refresh:N}=Qe("organizer-events-table",()=>$.apiFetch("/api/v1/events/",{baseURL:z("/api/v1/events/"),query:{limit:200}}),{default:()=>[]}),Q=new Intl.NumberFormat("ru-RU"),ae=new Intl.NumberFormat("ru-RU",{style:"currency",currency:"RUB",maximumFractionDigits:0}),ne=new Intl.DateTimeFormat("ru-RU",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}),oe=new Intl.DateTimeFormat("ru-RU",{day:"2-digit",month:"short",year:"numeric"}),W=e=>{if(!e)return 0;const t=Date.parse(e);return Number.isNaN(t)?0:t},re=e=>e?ne.format(new Date(e)):"Дата не указана",ue=e=>e?oe.format(new Date(e)):"Дата не указана",ie=e=>ae.format(Math.round(e)),de=e=>e.trim()?e.trim().split(" ").map(t=>t.charAt(0)).filter(Boolean).slice(0,2).join("").toUpperCase():"SE",ce=e=>e==="draft"?"Черновик":e==="scheduled"?"Запланировано":e==="cancelled"?"Отменено":e==="postponed"?"Перенесено":e==="done"?"Завершено":e,fe=e=>e==="draft"?"warning":e==="scheduled"?"success":e==="postponed"?"warning":e==="cancelled"?"secondary":"outline",me=e=>{const t=e.default_venue;if(t?.name)return t.city?`${t.name}, ${t.city}`:t.name;const l=e.occurrences.find(i=>i.venue?.name)?.venue;return l?.name?l.city?`${l.name}, ${l.city}`:l.name:"Площадка не указана"},pe=e=>[...e.images??[]].sort((t,l)=>(t.sort_order??0)-(l.sort_order??0))[0]?.url||"",ge=_(()=>se.value??[]),w=_(()=>ge.value.map(e=>{const t=(e.occurrences??[]).map(c=>W(c.start_time)).filter(c=>c>0).sort((c,b)=>c-b),l=t[0]??0,i=t[t.length-1]??l,D=W(e.created_at),S=(e.tickets??[]).reduce((c,b)=>c+(b.sold??0),0),$e=(e.tickets??[]).reduce((c,b)=>c+(b.price??0)*(b.sold??0),0);return{id:e.id,uuid:e.uuid,title:e.title,slug:e.slug,status:e.status,coverUrl:pe(e),venueLabel:me(e),ticketsSold:S,revenue:$e,firstStartAtTs:l,lastStartAtTs:i,eventDateLabel:re(l),createdAtTs:D,createdDateLabel:ue(D),titleInitials:de(e.title)}})),ve=(e,t)=>e.status==="draft"||e.status==="cancelled"||e.status==="done"?!1:e.lastStartAtTs>=t,xe=(e,t)=>e.status==="draft"?!1:e.status==="cancelled"||e.status==="done"?!0:e.lastStartAtTs>0&&e.lastStartAtTs<t,F=(e,t,l)=>t==="draft"?e.status==="draft":t==="upcoming"?ve(e,l):t==="past"?xe(e,l):!0,be=_(()=>{const e=Date.now();return[{key:"all",label:"Все",count:w.value.length},{key:"upcoming",label:"Предстоящие",count:w.value.filter(t=>F(t,"upcoming",e)).length},{key:"past",label:"Прошедшие",count:w.value.filter(t=>F(t,"past",e)).length},{key:"draft",label:"Черновики",count:w.value.filter(t=>F(t,"draft",e)).length}]}),P=_(()=>{const e=Date.now(),t=G.value;let l=w.value.filter(i=>F(i,M.value,e));return t&&(l=l.filter(i=>i.title.toLowerCase().includes(t))),l.sort((i,D)=>{const S=i.createdAtTs-D.createdAtTs;return S!==0?R.value==="asc"?S:-S:i.id-D.id}),l}),ye=_(()=>R.value==="desc"?"новые сверху":"старые сверху"),X=_(()=>!!p.value&&v.value.trim().length>=4&&!g.value),_e=()=>{R.value=R.value==="desc"?"asc":"desc"},he=e=>{h.value=h.value===e?null:e},B=()=>{h.value=null},E=e=>{A.value=e,T&&clearTimeout(T),T=setTimeout(()=>{A.value=""},3500)},ke=()=>{H("/events/create")},Ce=e=>{B(),H(`/events/${e.id}/edit`)},Te=e=>{B(),H(`/events/${e.id}/live`)},J=async e=>$.apiFetch(`/api/v1/events/${e}`,{baseURL:z("/api/v1/events")}),K=(e,t={})=>({title:t.title??e.title,slug:t.slug??e.slug,description:e.description??null,full_text:e.full_text??null,language:e.language??"ru",age_restriction:e.age_restriction??0,status:t.status??e.status,quality_score:e.quality_score??0,organizer:e.organizer??null,default_venue:e.default_venue??null,tags:e.tags??[],occurrences:e.occurrences??[],tickets:e.tickets??[],images:e.images??[],sources:[]}),we=e=>{const t=e.toLowerCase().replace(/[^a-z0-9-]+/g,"-").replace(/-+/g,"-").replace(/^-+|-+$/g,""),l=Date.now().toString(36);return`${t||"event"}-copy-${l}`.slice(0,96)},De=async e=>{B(),V.value=e.id;try{const t=await J(e.uuid),l=K(t,{title:`${t.title} (копия)`,slug:we(t.slug),status:"draft"});await $.apiFetch("/api/v1/events/",{method:"POST",baseURL:z("/api/v1/events/"),body:l}),E(`Копия события "${e.title}" создана`),await N()}catch{E("Не удалось создать копию события")}finally{V.value=null}},Se=e=>{B(),p.value=e,v.value="",k.value=!0},Y=()=>{g.value||(k.value=!1,p.value=null,v.value="")},Ue=async()=>{if(!(!p.value||!X.value)){g.value=!0;try{const e=await J(p.value.uuid),t=K(e,{status:"cancelled"});await $.apiFetch(`/api/v1/events/${p.value.uuid}`,{method:"PUT",baseURL:z("/api/v1/events"),body:t}),E(`Событие "${p.value.title}" отменено. Причина: ${v.value.trim()}`),await N(),Y()}catch{E("Не удалось отменить событие")}finally{g.value=!1}}},Z=e=>{e.target?.closest("[data-row-menu-root]")||(h.value=null)};return Ae(()=>{window.addEventListener("click",Z)}),Fe(()=>{window.removeEventListener("click",Z),C&&clearTimeout(C),T&&clearTimeout(T)}),(e,t)=>(f(),y("div",Ze,[a("section",et,[a("div",tt,[t[4]||(t[4]=a("div",{class:"space-y-1"},[a("p",{class:"text-xs font-semibold uppercase tracking-[0.3em] text-muted-foreground"},"Event Manager"),a("h1",{class:"text-2xl font-bold text-foreground"},"Управление событиями"),a("p",{class:"text-sm text-muted-foreground"}," Управляй всеми ивентами в одном месте: статус, продажи, выручка и быстрые действия. ")],-1)),n(s(U),{class:"gap-2",onClick:ke},{default:o(()=>[n(s(We),{class:"h-4 w-4"}),t[3]||(t[3]=r(" Создать событие ",-1))]),_:1})])]),a("section",st,[a("div",lt,[a("div",at,[a("div",nt,[n(s(Je),{class:"pointer-events-none absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),n(s(ze),{modelValue:s(L),"onUpdate:modelValue":t[0]||(t[0]=l=>j(L)?L.value=l:null),class:"h-11 pl-10",placeholder:"Поиск по названию события"},null,8,["modelValue"])]),a("div",ot,[(f(!0),y(ee,null,te(s(be),l=>(f(),y("button",{key:l.key,type:"button",class:Be(["inline-flex items-center rounded-full px-4 py-2 text-xs font-semibold transition",s(M)===l.key?"bg-primary/10 text-primary":"text-muted-foreground hover:text-foreground"]),onClick:i=>M.value=l.key},[r(u(l.label)+" ",1),a("span",ut,u(l.count),1)],10,rt))),128))])]),n(s(U),{variant:"outline",size:"sm",onClick:s(N)},{default:o(()=>[...t[5]||(t[5]=[r(" Обновить ",-1)])]),_:1},8,["onClick"])]),a("div",it,[a("span",null,"Показано: "+u(s(Q).format(s(P).length)),1),a("span",null,"Сортировка: дата создания, "+u(s(ye)),1)]),s(A)?(f(),y("p",dt,u(s(A)),1)):O("",!0),a("div",ct,[n(s(Ne),null,{default:o(()=>[n(s(Pe),null,{default:o(()=>[n(s(I),null,{default:o(()=>[n(s(x),null,{default:o(()=>[...t[6]||(t[6]=[r("Название",-1)])]),_:1}),n(s(x),null,{default:o(()=>[a("button",{type:"button",class:"inline-flex items-center gap-1 font-semibold text-muted-foreground transition hover:text-foreground",onClick:_e},[t[7]||(t[7]=r(" Дата ",-1)),n(s(Xe),{class:"h-3.5 w-3.5"})])]),_:1}),n(s(x),null,{default:o(()=>[...t[8]||(t[8]=[r("Площадка",-1)])]),_:1}),n(s(x),null,{default:o(()=>[...t[9]||(t[9]=[r("Статус",-1)])]),_:1}),n(s(x),null,{default:o(()=>[...t[10]||(t[10]=[r("Билетов продано",-1)])]),_:1}),n(s(x),null,{default:o(()=>[...t[11]||(t[11]=[r("Выручка",-1)])]),_:1}),n(s(x),{class:"text-right"},{default:o(()=>[...t[12]||(t[12]=[r("Действия",-1)])]),_:1})]),_:1})]),_:1}),n(s(je),null,{default:o(()=>[s(le)?(f(),q(s(I),{key:0},{default:o(()=>[n(s(m),{colspan:"7",class:"py-12 text-center text-sm text-muted-foreground"},{default:o(()=>[...t[13]||(t[13]=[r(" Загружаем события... ",-1)])]),_:1})]),_:1})):s(P).length===0?(f(),q(s(I),{key:1},{default:o(()=>[n(s(m),{colspan:"7",class:"py-12 text-center text-sm text-muted-foreground"},{default:o(()=>[...t[14]||(t[14]=[r(" События не найдены ",-1)])]),_:1})]),_:1})):O("",!0),(f(!0),y(ee,null,te(s(P),l=>(f(),q(s(I),{key:l.id},{default:o(()=>[n(s(m),null,{default:o(()=>[a("div",ft,[n(s(qe),{class:"h-10 w-10"},{default:o(()=>[n(s(He),{src:l.coverUrl},null,8,["src"]),n(s(Ge),{class:"bg-primary/10 font-semibold text-primary"},{default:o(()=>[r(u(l.titleInitials),1)]),_:2},1024)]),_:2},1024),a("div",mt,[a("p",pt,u(l.title),1),a("p",gt,"slug: "+u(l.slug),1)])])]),_:2},1024),n(s(m),null,{default:o(()=>[a("p",vt,u(l.eventDateLabel),1),a("p",xt,"Создано: "+u(l.createdDateLabel),1)]),_:2},1024),n(s(m),{class:"max-w-[220px]"},{default:o(()=>[a("p",bt,u(l.venueLabel),1)]),_:2},1024),n(s(m),null,{default:o(()=>[n(s(Me),{variant:fe(l.status)},{default:o(()=>[r(u(ce(l.status)),1)]),_:2},1032,["variant"])]),_:2},1024),n(s(m),{class:"font-semibold text-foreground"},{default:o(()=>[r(u(s(Q).format(l.ticketsSold)),1)]),_:2},1024),n(s(m),{class:"font-semibold text-foreground"},{default:o(()=>[r(u(ie(l.revenue)),1)]),_:2},1024),n(s(m),{class:"text-right"},{default:o(()=>[a("div",yt,[n(s(U),{variant:"ghost",size:"icon",onClick:Ee(i=>he(l.id),["stop"])},{default:o(()=>[n(s(Ye),{class:"h-4 w-4"})]),_:1},8,["onClick"]),s(h)===l.id?(f(),y("div",_t,[a("button",{type:"button",class:"flex w-full items-center rounded-lg px-3 py-2 text-left text-sm hover:bg-muted",onClick:i=>Ce(l)}," Редактировать ",8,ht),a("button",{type:"button",class:"flex w-full items-center rounded-lg px-3 py-2 text-left text-sm hover:bg-muted",onClick:i=>Te(l)}," Пульт управления ",8,kt),a("button",{type:"button",class:"flex w-full items-center rounded-lg px-3 py-2 text-left text-sm hover:bg-muted",disabled:s(V)===l.id||s(g),onClick:i=>De(l)},u(s(V)===l.id?"Клонируем...":"Клонировать"),9,Ct),a("button",{type:"button",class:"flex w-full items-center rounded-lg px-3 py-2 text-left text-sm text-destructive hover:bg-muted",disabled:l.status==="cancelled",onClick:i=>Se(l)},u(l.status==="cancelled"?"Уже отменено":"Отменить"),9,Tt)])):O("",!0)])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})])]),n(s(Oe),{modelValue:s(k),"onUpdate:modelValue":t[2]||(t[2]=l=>j(k)?k.value=l:null)},{default:o(()=>[a("div",wt,[a("div",Dt,[t[16]||(t[16]=a("h3",{class:"text-lg font-semibold text-foreground"},"Подтвердите отмену события",-1)),a("p",St,[t[15]||(t[15]=r(" Событие: ",-1)),a("span",Ut,u(s(p)?.title),1)])]),a("div",$t,[t[17]||(t[17]=a("label",{class:"text-xs font-semibold uppercase tracking-[0.2em] text-muted-foreground"}," Причина отмены ",-1)),n(s(Ie),{modelValue:s(v),"onUpdate:modelValue":t[1]||(t[1]=l=>j(v)?v.value=l:null),disabled:s(g),placeholder:"Например: перенос площадки, отмена выступления хедлайнера"},null,8,["modelValue","disabled"])]),a("div",Lt,[n(s(U),{variant:"outline",disabled:s(g),onClick:Y},{default:o(()=>[...t[18]||(t[18]=[r(" Назад ",-1)])]),_:1},8,["disabled"]),n(s(U),{variant:"destructive",disabled:!s(X),onClick:Ue},{default:o(()=>[r(u(s(g)?"Отменяем...":"Подтвердить отмену"),1)]),_:1},8,["disabled"])])])]),_:1},8,["modelValue"])]))}});export{Zt as default};
